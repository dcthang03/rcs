<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>Dealer – All In One (FIX FULL)</title>

<style>
/* ===== GLOBAL LOCK ===== */
html, body {
  margin: 0;
  padding: 0;
  height: 100%;
  overflow: hidden;
  overscroll-behavior: none;
  touch-action: manipulation;
  background: #0e0e11;
  color: #fff;
  font-family: system-ui, sans-serif;
}

input, button { font-size: 16px; }

/* ===== LOGIN ===== */
#loginView {
  position: fixed;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  background: #0e0e11;
  z-index: 1000;
}
#loginBox {
  width: 300px;
  background: #000;
  padding: 16px;
    border-radius: 14px;
  text-align: center;
}

#loginBox select {
  width: 100%;
  padding: 16px;
  border-radius: 8px;
  border: none;
  margin-bottom: 14px;
  font-size: 16px;
}

/* PIN */
.pin-display {
  display: flex;
  justify-content: space-between;
  margin: 16px 0;
}
.pin-dot {
  width: 16px;
  height: 16px;
  border: 2px solid #444;
  border-radius: 50%;
}
.pin-dot.filled {
  background: #0a84ff;
  border-color: #0a84ff;
}

/* Keypad */
.keypad {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 10px;
}
.keypad button {
  padding: 14px;
  font-size: 18px;
  border-radius: 10px;
  border: none;
  background: #1f2937;
  color: #fff;
}
.keypad button:active {
  background: #374151;
}

/* ===== PANEL ===== */
#panelView {
  display: none;
  width: 100%;
  height: 100%;
}

/* ===== TABLE ===== */
.table-area {
  width: 100vw;
  height: 100vh;
  display: flex;
  align-items: center;
  justify-content: center;
  transform: translateY(-12vh);
}
.table {
  position: relative;
  width: 270px;
  height: 190px;
  border-radius: 200px;
  background: radial-gradient(circle, #1c1c1c, #0f0f0f 70%);
  border: 4px solid #2a2a2a;
}
.seat {
  position: absolute;
  width: 60px;
  height: 60px;
  border-radius: 50%;
  background: #1f2937;
  border: 2px solid #374151;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  font-weight: 600;
  cursor: pointer;
  user-select: none;
  -webkit-user-select: none;
  -webkit-touch-callout: none;
  touch-action: none;
}
.seat.occupied {
  background: #0a84ff;
  border-color: #0a84ff;
}
.seat small {
  font-size: 10px;
  opacity: .9;
}
</style>
</head>

<body>

<!-- ===== LOGIN VIEW ===== -->
<div id="loginView">
  <div id="loginBox">
    <h3 style="margin:0 0 10px">Dealer Login</h3>

    <select id="tableSelect">
      <option value="">-- Chọn bàn --</option>

    </select>

    <div class="pin-display">
      <div class="pin-dot"></div>
      <div class="pin-dot"></div>
      <div class="pin-dot"></div>
      <div class="pin-dot"></div>
    </div>

    <div class="keypad">
      <button onclick="press(1)">1</button>
      <button onclick="press(2)">2</button>
      <button onclick="press(3)">3</button>

      <button onclick="press(4)">4</button>
      <button onclick="press(5)">5</button>
      <button onclick="press(6)">6</button>

      <button onclick="press(7)">7</button>
      <button onclick="press(8)">8</button>
      <button onclick="press(9)">9</button>

      <button onclick="backPin()">←</button>
      <button onclick="press(0)">0</button>
      <button onclick="submitLogin()">OK</button>
    </div>
  </div>
</div>

<!-- ===== PANEL VIEW ===== -->
<div id="panelView">
  <div class="table-area">
    <div class="table" id="table"></div>
  </div>
</div>

<!-- ===== QR MODAL ===== -->
<div id="qrModal" style="
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.85);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9999;
">
  <div style="width:260px;background:#000;padding:12px;border-radius:12px">
    <div id="qr-reader" style="width:100%; min-height:240px"></div>
    <button id="closeQR" style="
      width:100%;
      margin-top:10px;
      padding:10px;
      border:none;
      border-radius:8px;
      background:#374151;
      color:#fff;
      font-size:16px;
    ">Cancel</button>
  </div>
</div>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="https://unpkg.com/html5-qrcode"></script>

<script>
/* ===== LOCK ZOOM ===== */
document.addEventListener('gesturestart', e => e.preventDefault());
document.addEventListener('gesturechange', e => e.preventDefault());
document.addEventListener('gestureend', e => e.preventDefault());



/* ===== SUPABASE ===== */
const SUPABASE_URL = 'https://ymtmipkmknnsqleahlmi.supabase.co'
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InltdG1pcGtta25uc3FsZWFobG1pIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAwOTU1MjUsImV4cCI6MjA4NTY3MTUyNX0.7pEza-TKBKJ_xqdBu93nLo-PRaHDcDIxW-bjZnrFJxw'
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY)

loadTables()


/* ===== LOGIN WITH PIN ===== */
let TABLE_ID = null
let pin = ''

function press(n) {
  if (pin.length >= 4) return
  pin += n
  updateDots()
}

function backPin() {
  pin = pin.slice(0, -1)
  updateDots()
}

function updateDots() {
  document.querySelectorAll('.pin-dot').forEach((d, i) => {
    d.classList.toggle('filled', i < pin.length)
  })
}

/* === load tables === */

async function loadTables() {
  const { data, error } = await sb
    .from('tables')
    .select('table_id')
    .eq('active', true)
    .order('table_id')

  if (error) {
    alert('Không load được danh sách bàn')
    return
  }

  const select = document.getElementById('tableSelect')

  data.forEach(row => {
    const opt = document.createElement('option')
    opt.value = row.table_id        // A1
    opt.textContent = 'Bàn ' + row.table_id
    select.appendChild(opt)
  })
}





async function submitLogin() {
  const table = document.getElementById('tableSelect').value
  if (!table) return alert('Chưa chọn bàn')
  if (pin.length !== 4) return alert('PIN phải đủ 4 số')

  const { data, error } = await sb
    .from('tables')
    .select('table_id, pin_hash, active')
    .eq('table_id', table)
    .single()

  if (error || !data) {
    resetPin()
    return alert('Bàn không tồn tại')
  }

  if (!data.active) {
    resetPin()
    return alert('Bàn đang bị khóa')
  }

  // ⚠️ so sánh plain text (tạm thời)
  if (data.pin_hash !== pin) {
    resetPin()
    return alert('Sai PIN')
  }

  // ✅ LOGIN OK
  TABLE_ID = data.table_id
  document.getElementById('loginView').style.display = 'none'
  document.getElementById('panelView').style.display = 'block'

  initPanel()
}

function resetPin() {
  pin = ''
  document.querySelectorAll('.pin-dot')
    .forEach(d => d.classList.remove('filled'))
}




/* ===== CONFIG ===== */
const SEAT_COUNT = 9
const TOP_SEAT = 5
const SEAT_SIZE = 60
const TABLE_BORDER = 4
const SAFE_PADDING = 8
const HOLD_TIME = 700

const seatState = {}
const seats = {}
let holdTimer = null
const tableEl = document.getElementById('table')

/* ===== INIT PANEL ===== */
function initPanel() {
  createSeats()
  renderSeats()
  loadSeats()
  initRealtime()
  window.addEventListener('resize', renderSeats)
}

/* ===== SEATS ===== */
function createSeats() {
  for (let i = 1; i <= SEAT_COUNT; i++) {
    seatState[i] = { uid: null }

    const seat = document.createElement('div')
    seat.className = 'seat'

    const num = document.createElement('div')
    num.textContent = i
    const uidEl = document.createElement('small')

    seat.appendChild(num)
    seat.appendChild(uidEl)

    seat.addEventListener('pointerdown', () => {
      clearTimeout(holdTimer)
      holdTimer = setTimeout(() => {
        if (seatState[i].uid) {
          if (confirm(`Reject UID ${seatState[i].uid.slice(0,6)} ?`)) {
            ejectUID(i)
          }
        } else {
          scanQRAndAssign(i)
        }
      }, HOLD_TIME)
    })

    seat.addEventListener('pointerup', ()=>clearTimeout(holdTimer))
    seat.addEventListener('pointerleave', ()=>clearTimeout(holdTimer))
    seat.addEventListener('pointercancel', ()=>clearTimeout(holdTimer))

    seats[i] = { el: seat, uidEl }
    tableEl.appendChild(seat)
  }
}

/* ===== RENDER ===== */
function renderSeats() {
  const rect = tableEl.getBoundingClientRect()
  const cx = rect.width / 2
  const cy = rect.height / 2
  const rX = cx - SEAT_SIZE/2 - TABLE_BORDER - SAFE_PADDING + 50
  const rY = cy - SEAT_SIZE/2 - TABLE_BORDER - SAFE_PADDING + 50

  for (let i = 1; i <= SEAT_COUNT; i++) {
    const { el, uidEl } = seats[i]
    const angle = (Math.PI*2/SEAT_COUNT)*(i-TOP_SEAT) - Math.PI/2

    el.style.left = cx + Math.cos(angle)*rX + 'px'
    el.style.top  = cy + Math.sin(angle)*rY + 'px'
    el.style.transform = 'translate(-50%,-50%)'

    el.classList.toggle('occupied', !!seatState[i].uid)
    uidEl.textContent = seatState[i].uid ? seatState[i].uid.slice(0,4) : ''
  }
}

/* ===== DB / REALTIME / QR ===== */
/* (GIỮ NGUYÊN PHẦN CÒN LẠI CỦA BẠN – KHÔNG ĐỘNG GÌ) */

/* ===== DB ===== */
async function assignUID(seat, uid) {
  seatState[seat].uid = uid
  renderSeats()

  const { data, error } = await sb
    .from('seats')
    .update({ uid })
    .eq('table_id', TABLE_ID)
    .eq('seat_number', String(seat))
    .select()

  if (error || !data?.length) {
    seatState[seat].uid = null
    renderSeats()
    alert('❌ Gán UID thất bại')
  }
}

async function ejectUID(seat) {
  const old = seatState[seat].uid
  seatState[seat].uid = null
  renderSeats()

  const { data, error } = await sb
    .from('seats')
    .update({ uid: null })
    .eq('table_id', TABLE_ID)
    .eq('seat_number', String(seat))
    .select()

  if (error || !data?.length) {
    seatState[seat].uid = old
    renderSeats()
    alert('❌ Reject thất bại')
  }
}

async function loadSeats() {
  const { data } = await sb
    .from('seats')
    .select('*')
    .eq('table_id', TABLE_ID)

  data?.forEach(r => {
    seatState[String(r.seat_number)].uid = r.uid
  })
  renderSeats()
}

/* ===== REALTIME ===== */
function initRealtime() {
  sb.channel('seats-' + TABLE_ID)
    .on(
      'postgres_changes',
      {
        event: '*',
        schema: 'public',
        table: 'seats',
        filter: `table_id=eq.${TABLE_ID}`
      },
      p => {
        seatState[p.new.seat_number].uid = p.new.uid
        renderSeats()
      }
    )
    .subscribe()
}

/* ===== QR ===== */
let qrScanner = null

async function scanQRAndAssign(seatIndex) {
  const modal = document.getElementById('qrModal')
  const closeBtn = document.getElementById('closeQR')

  modal.style.display = 'flex'
  await safeStopQR()

  setTimeout(async () => {
    qrScanner = new Html5Qrcode('qr-reader')
    qrScanner.start(
      { facingMode: 'environment' },
      { fps: 10, qrbox: 220, aspectRatio: 1 },
      async text => {
        await safeStopQR()
        modal.style.display = 'none'

        const uid = text?.trim().replace(/[^a-zA-Z0-9]/g,'').toUpperCase()
        if (!uid) return alert('QR không hợp lệ')
        assignUID(seatIndex, uid)
      }
    )
  }, 150)

  closeBtn.onclick = async () => {
    await safeStopQR()
    modal.style.display = 'none'
  }
}

async function safeStopQR() {
  if (qrScanner) {
    try {
      if (qrScanner.isScanning) await qrScanner.stop()
      await qrScanner.clear()
    } catch(e){}
    qrScanner = null
  }
}



console.log('dealer2.html V.101')
</script>

</body>
</html>
