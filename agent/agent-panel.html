<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Agent Panel</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

<style>

*{
  margin:0;
  padding:0;
  box-sizing:border-box;
  font-family:'Inter',sans-serif;
}

body{
  background:#020617;
  color:white;
  min-height:100vh;
}

.main{
  padding:24px;
}

.topbar{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:28px;
}

.logout{
  padding:8px 14px;
  border-radius:10px;
  border:1px solid rgba(255,255,255,0.15);
  cursor:pointer;
  color:#f87171;
}

.logout:hover{
  background:rgba(248,113,113,0.1);
}

.agent-name{
  color:#94a3b8;
  margin-bottom:20px;
}

.footer{
  margin-top:24px;
  text-align:center;
  color:#64748b;
  font-size:12px;
}

/* CARDS */

.cards{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(160px,1fr));
  gap:16px;
  margin-bottom:32px;
}

.card{
  padding:18px;
  border-radius:14px;
  background:rgba(255,255,255,0.04);
  border:1px solid rgba(255,255,255,0.06);
}

.card[data-view]{
  cursor:pointer;
  transition:.2s;
}

.card[data-view]:hover{
  transform:translateY(-4px);
}

.card.active{
  border:1px solid #4ade80;
  background:rgba(74,222,128,0.08);
}

.card-title{
  color:#94a3b8;
  font-size:13px;
}

.card-value{
  font-size:24px;
  font-weight:600;
  margin-top:6px;
}

/* TABLE */

.section-title{
  margin-bottom:12px;
}

.table{
  width:100%;
  border-collapse:collapse;
}

.table th{
  text-align:left;
  padding:12px;
  color:#94a3b8;
  border-bottom:1px solid rgba(255,255,255,0.06);
}

.table td{
  padding:14px 12px;
  border-bottom:1px solid rgba(255,255,255,0.04);
}

</style>
</head>
<body>

<div class="main">

  <div class="topbar">
    <h2>Agent Panel</h2>
    <div class="logout" onclick="logout()">Logout</div>
  </div>

  <div class="agent-name" id="agentName"></div>

  <div class="cards">

    <div class="card">
      <div class="card-title">Total Players</div>
      <div class="card-value" id="totalPlayers">--</div>
    </div>

    <div class="card" data-view="total">
      <div class="card-title">Total Rake</div>
      <div class="card-value" id="totalRake">--</div>
    </div>

    <div class="card active" data-view="this_week">
      <div class="card-title">This Week</div>
      <div class="card-value" id="thisWeekRake">--</div>
    </div>

    <div class="card" data-view="last_week">
      <div class="card-title">Last Week</div>
      <div class="card-value" id="lastWeekRake">--</div>
    </div>

  </div>

  <div class="section">
    <div class="section-title">Your Players</div>

    <table class="table">
      <thead>
        <tr>
          <th>Player ID</th>
          
          <th id="tableMetric">This Week</th>
          
        </tr>
      </thead>
      <tbody id="playersBody"></tbody>
    </table>
  </div>

  <div class="footer">Internal System</div>

</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>

// =============================
// SUPABASE INIT
// =============================

const sb = supabase.createClient(
  "https://ymtmipkmknnsqleahlmi.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InltdG1pcGtta25uc3FsZWFobG1pIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAwOTU1MjUsImV4cCI6MjA4NTY3MTUyNX0.7pEza-TKBKJ_xqdBu93nLo-PRaHDcDIxW-bjZnrFJxw"
);

const agent_uid = localStorage.getItem("agent_uid");

if(!agent_uid){
  window.location.href = "./agent-login.html";
}

// =============================
// GLOBAL STATE
// =============================

let allPlayers = [];
let realtimeStarted = false;

// Business week (SERVER DRIVEN)
let WEEK_START = null;
let LAST_WEEK_START = null;
let WEEK_END = null;

// DOM
const playersBody = document.getElementById("playersBody");
const totalPlayersEl = document.getElementById("totalPlayers");
const totalRakeEl = document.getElementById("totalRake");
const thisWeekRakeEl = document.getElementById("thisWeekRake");
const lastWeekRakeEl = document.getElementById("lastWeekRake");
const agentNameEl = document.getElementById("agentName");

// make Total Players clickable
document.querySelector("#totalPlayers")
.closest(".card")
.setAttribute("data-view","players_state");

// =============================
// FETCH PLAYERS
// =============================

async function getPlayers(){

  const { data, error } = await sb
    .from("players")
    .select("player_uid,total_rake")
    .eq("agent_uid", agent_uid);

  if(error){
    console.error(error);
    return [];
  }

  return data || [];
}

// =============================
// LOAD THIS + LAST WEEK
// (financial-safe pattern)
// =============================

async function attachWeeklyRake(players){

  const { data, error } = await sb
    .from("rake_logs")
    .select("player_uid,rake,created_at")
    .eq("agent_uid", agent_uid)
    .gte("created_at", LAST_WEEK_START)
    .lt("created_at", WEEK_END);

  if(error){
    console.error(error);
    return players;
  }

  const map = {};

  players.forEach(p=>{
    p.this_week = 0;
    p.last_week = 0;
    p.last_activity = null;
    p.last_rake = 0;

    map[p.player_uid] = p;
  });

  data?.forEach(log=>{

    const player = map[log.player_uid];
    if(!player) return;

    const ts = new Date(log.created_at);
    const rake = Number(log.rake);

    // classify week
    if(ts >= new Date(WEEK_START)){
      player.this_week += rake;
    }else{
      player.last_week += rake;
    }

    // last activity
    if(!player.last_activity || ts > new Date(player.last_activity)){
      player.last_activity = log.created_at;
      player.last_rake = rake;
    }

  });

  return players;
}

// =============================
// LOAD SEATS (ONLINE STATUS)
// =============================

async function attachPlayerState(players){

  const { data } = await sb
    .from("seats")
    .select("player_uid,table_uid,seat_number,seated_at")
    .not("player_uid","is",null);

  const seatMap = {};

  data?.forEach(seat=>{
    seatMap[String(seat.player_uid)] = seat;
  });

  players.forEach(p=>{

    const seat = seatMap[String(p.player_uid)];

    p.is_online = Boolean(seat);
    p.table_position = seat
      ? `${seat.table_uid}-${seat.seat_number}`
      : "-";

    p.seated_at = seat?.seated_at || null;
  });

  return players;
}

// =============================
// FORMATTERS
// =============================

function formatDuration(seatedAt){

  if(!seatedAt) return "-";

  const diff =
    (Date.now() - new Date(seatedAt)) / 60000;

  let color = "#4ade80";

  if(diff > 60) color = "#fbbf24";
  if(diff > 120) color = "#f87171";

  const h = Math.floor(diff / 60);
  const m = Math.floor(diff % 60);

  return `<span style="color:${color}">
            ${h}h ${m}m
          </span>`;
}

function formatLastActivity(player){

  if(!player.last_activity) return "-";

  const diffMin =
    (Date.now() - new Date(player.last_activity)) / 60000;

  if(diffMin >= 120) return "-";

  const amount = `+$${player.last_rake}`;

  if(diffMin < 1){
    const time =
      new Date(player.last_activity)
      .toLocaleTimeString([],{
        hour:'2-digit',
        minute:'2-digit'
      });

    return `${amount} ${time}`;
  }

  if(diffMin < 60)
    return `${amount} ${Math.floor(diffMin)}m ago`;

  return `${amount} ${Math.floor(diffMin/60)}h ago`;
}

// =============================
// RENDER
// =============================


  function renderTable(){

    const thead = document.querySelector(".table thead");

if(currentView === "players_state"){
  thead.innerHTML = `
    <tr>
      <th>Player</th>
      <th>Status</th>
      <th>Table</th>
    </tr>
  `;
}else{

  const label =
    currentView === "total"
      ? "Total Rake"
      : currentView === "last_week"
      ? "Last Week"
      : "This Week";

  thead.innerHTML = `
    <tr>
      <th>Player ID</th>
      <th>${label}</th>
      <th>Last Activity</th>
    </tr>
  `;
}


  // ===== PLAYER STATE VIEW =====
  if(currentView === "players_state"){

    playersBody.innerHTML = allPlayers
      .sort((a,b)=> b.is_online - a.is_online)
      .map(p=>`
        <tr>
          <td>${p.player_uid}</td>
          <td>
            ${
              p.is_online
                ? formatDuration(p.seated_at)
                : "ðŸ’¤"
            }
          </td>
          <td>${p.table_position}</td>
        </tr>
      `).join("");

    return;
  }

  // ===== RAKE VIEWS =====

  playersBody.innerHTML = allPlayers.map(p=>{

    let value = 0;

    if(currentView === "total")
      value = p.total_rake;

    else if(currentView === "last_week")
      value = p.last_week;

    else
      value = p.this_week;

    return `
      <tr>
        <td>${p.player_uid}</td>
        <td>$${value.toLocaleString()}</td>
        <td>${formatLastActivity(p)}</td>
      </tr>
    `;
  }).join("");
}



// =============================
// CARD SWITCH VIEW
// =============================

let currentView = "this_week";

document.querySelectorAll(".card[data-view]")
.forEach(card=>{

  card.addEventListener("click",()=>{

    document
      .querySelectorAll(".card[data-view]")
      .forEach(c=>c.classList.remove("active"));

    card.classList.add("active");

    currentView = card.dataset.view;

    renderTable();

  });

});


// =============================
// LOAD DASHBOARD
// =============================

async function loadDashboard(){

  // SERVER CLOCK
  const { data } = await sb.rpc('get_week_range');

  WEEK_START = data[0].start_this_week;
  LAST_WEEK_START = data[0].start_last_week;
  WEEK_END = data[0].end_this_week;

  agentNameEl.innerText = `UID: ${agent_uid}`;

  let players = await getPlayers();

  players = await attachWeeklyRake(players);
  players = await attachPlayerState(players);

  allPlayers = players;

  // TOTAL PLAYERS
const onlineCount =
  players.filter(p=>p.is_online).length;

totalPlayersEl.innerHTML =
  `<span style="color:#4ade80">${onlineCount}</span> / ${players.length}`;

  // cards
  const total = players.reduce((s,p)=>s+p.total_rake,0);
  const thisWeek = players.reduce((s,p)=>s+p.this_week,0);
  const lastWeek = players.reduce((s,p)=>s+p.last_week,0);

  totalRakeEl.innerText = "$"+total.toLocaleString();
  thisWeekRakeEl.innerText = "$"+thisWeek.toLocaleString();
  lastWeekRakeEl.innerText = "$"+lastWeek.toLocaleString();

  renderTable();

  // start realtime ONCE
  if(!realtimeStarted){
    startRealtime();
    realtimeStarted = true;
  }
}

// =============================
// REALTIME (NO DOUBLE SOCKET)
// =============================

function startRealtime(){

  sb.removeAllChannels();

  // RAKE STREAM
  sb.channel('rake-live')
  .on('postgres_changes',{
      event:'INSERT',
      schema:'public',
      table:'rake_logs',
      filter:`agent_uid=eq.${agent_uid}`
  }, payload=>{

      const log = payload.new;
      const player = allPlayers.find(
        p=>p.player_uid===log.player_uid
      );

      if(!player) return;

      const ts = new Date(log.created_at);
      const rake = Number(log.rake);

      player.total_rake += rake;

     if(
   ts >= new Date(WEEK_START) &&
   ts < new Date(WEEK_END)
){
   player.this_week += rake;
}else{
   player.last_week += rake;
}

      player.last_activity = log.created_at;
      player.last_rake = rake;

      // âœ… UPDATE CARDS REALTIME
totalRakeEl.innerText =
  "$" + allPlayers
    .reduce((s,p)=>s+p.total_rake,0)
    .toLocaleString();

thisWeekRakeEl.innerText =
  "$" + allPlayers
    .reduce((s,p)=>s+p.this_week,0)
    .toLocaleString();

lastWeekRakeEl.innerText =
  "$" + allPlayers
    .reduce((s,p)=>s+p.last_week,0)
    .toLocaleString();

renderTable();
      
      
      
      
      renderTable();
  })
  .subscribe();

}

// =============================
// AUTO WEEK ROLLOVER
// =============================

async function reloadBusinessData(){

  const { data } = await sb.rpc('get_week_range');

  const newStart = data[0].start_this_week;

  if(newStart === WEEK_START) return;

  console.log("NEW WEEK DETECTED");

  realtimeStarted = false;

  await loadDashboard();
}

// =============================
// START
// =============================

loadDashboard();

// check rollover má»—i 60s
setInterval(reloadBusinessData, 60000);

</script>



</body>
</html>
