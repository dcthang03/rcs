<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Agent Panel</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

<style>

*{
  margin:0;
  padding:0;
  box-sizing:border-box;
  font-family:'Inter',sans-serif;
}

body{
  background:#020617;
  color:white;
  min-height:100vh;
}

.main{
  padding:24px;
}

.topbar{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:28px;
}

.logout{
  padding:8px 14px;
  border-radius:10px;
  border:1px solid rgba(255,255,255,0.15);
  cursor:pointer;
  color:#f87171;
}

.logout:hover{
  background:rgba(248,113,113,0.1);
}

.agent-name{
  color:#94a3b8;
  margin-bottom:20px;
}

.footer{
  margin-top:24px;
  text-align:center;
  color:#64748b;
  font-size:12px;
}

/* CARDS */

.cards{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(160px,1fr));
  gap:16px;
  margin-bottom:32px;
}

.card{
  padding:18px;
  border-radius:14px;
  background:rgba(255,255,255,0.04);
  border:1px solid rgba(255,255,255,0.06);
}

.card[data-view]{
  cursor:pointer;
  transition:.2s;
}

.card[data-view]:hover{
  transform:translateY(-4px);
}

.card.active{
  border:1px solid #4ade80;
  background:rgba(74,222,128,0.08);
}

.card-title{
  color:#94a3b8;
  font-size:13px;
}

.card-value{
  font-size:24px;
  font-weight:600;
  margin-top:6px;
}

/* TABLE */

.section-title{
  margin-bottom:12px;
}

.table{
  width:100%;
  border-collapse:collapse;
}

.table th{
  text-align:left;
  padding:12px;
  color:#94a3b8;
  border-bottom:1px solid rgba(255,255,255,0.06);
}

.table td{
  padding:14px 12px;
  border-bottom:1px solid rgba(255,255,255,0.04);
}

</style>
</head>
<body>

<div class="main">

  <div class="topbar">
    <h2>Agent Panel</h2>
    <div class="logout" onclick="logout()">Logout</div>
  </div>

  <div class="agent-name" id="agentName"></div>

  <div class="cards">

    <div class="card">
      <div class="card-title">Total Players</div>
      <div class="card-value" id="totalPlayers">--</div>
    </div>

    <div class="card" data-view="total">
      <div class="card-title">Total Rake</div>
      <div class="card-value" id="totalRake">--</div>
    </div>

    <div class="card active" data-view="this_week">
      <div class="card-title">This Week</div>
      <div class="card-value" id="thisWeekRake">--</div>
    </div>

    <div class="card" data-view="last_week">
      <div class="card-title">Last Week</div>
      <div class="card-value" id="lastWeekRake">--</div>
    </div>

  </div>

  <div class="section">
    <div class="section-title">Your Players</div>

    <table class="table">
      <thead>
        <tr>
          <th>Player ID</th>
          <th id="tableMetric">This Week</th>
        </tr>
      </thead>
      <tbody id="playersBody"></tbody>
    </table>
  </div>

  <div class="footer">Internal System</div>

</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>

// INIT
const sb = supabase.createClient(
  "https://ymtmipkmknnsqleahlmi.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InltdG1pcGtta25uc3FsZWFobG1pIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAwOTU1MjUsImV4cCI6MjA4NTY3MTUyNX0.7pEza-TKBKJ_xqdBu93nLo-PRaHDcDIxW-bjZnrFJxw"
);

const agent_uid = localStorage.getItem("agent_uid");

if(!agent_uid){
  window.location.href = "./agent-login.html";
}

// STATE
let allPlayers = [];
let currentView = "this_week";

let serverNow = null;          // Date (gi·ªù server)
let serverClockSkewMs = 0;     // serverNow - clientNow
let weekRolloverTimer = null;  // setTimeout handle


// DOM
const playersBody = document.getElementById("playersBody");
const totalPlayersEl = document.getElementById("totalPlayers");
const totalRakeEl = document.getElementById("totalRake");
const thisWeekRakeEl = document.getElementById("thisWeekRake");
const lastWeekRakeEl = document.getElementById("lastWeekRake");
const agentNameEl = document.getElementById("agentName");
const tableMetric = document.getElementById("tableMetric");

// ‚≠ê MAKE TOTAL PLAYERS CLICKABLE
document.querySelector("#totalPlayers")
.closest(".card")
.setAttribute("data-view","players_state");


// FETCH PLAYERS
async function getPlayers(){

  const { data, error } = await sb
    .from("players")
    .select("player_uid,total_rake")
    .eq("agent_uid", agent_uid); // ‚≠ê QUAN TR·ªåNG NH·∫§T

  if(error){
    console.error(error);
    return [];
  }

  return data || [];
}

// h√†m l·∫•y gi·ªù server

async function syncServerTime(){
  const { data, error } = await sb.rpc("get_server_now");
  if(error){
    console.error("get_server_now error:", error);
    // fallback: n·∫øu l·ªói RPC th√¨ d√πng gi·ªù m√°y, nh∆∞ng s·∫Ω k√©m ch√≠nh x√°c
    serverNow = new Date();
    serverClockSkewMs = 0;
    return;
  }

  // data th∆∞·ªùng l√† string ISO timestamptz
  const sNow = new Date(data);
  const cNow = new Date();

  serverNow = sNow;
  serverClockSkewMs = sNow.getTime() - cNow.getTime();
}

function getServerNow(){
  return new Date(Date.now() + serverClockSkewMs);
}


// WEEK RANGE
function getWeekRange(offset = 0, baseDate = null){

  const now = baseDate ? new Date(baseDate) : getServerNow();

  const day = now.getDay(); // 0=Sun..6=Sat
  const diffToMonday = (day === 0 ? -6 : 1 - day);

  const monday = new Date(now);
  monday.setDate(now.getDate() + diffToMonday + offset * 7);
  monday.setHours(0,0,0,0);

  const sunday = new Date(monday);
  sunday.setDate(monday.getDate() + 6);
  sunday.setHours(23,59,59,999);

  return { start: monday, end: sunday };
}



// =============================
// ATTACH WEEKLY RAKE
// =============================

async function attachWeeklyRake(players){

  const { data, error } = await sb
    .from("rake_logs")
    .select("player_uid,rake,created_at")
    .eq("agent_uid", agent_uid);

  if(error){
    console.error(error);
    return players;
  }

const base = getServerNow();
const thisWeek = getWeekRange(0, base);
const lastWeek = getWeekRange(-1, base);

  const map = {};

  players.forEach(p=>{
    p.this_week = 0;
    p.last_week = 0;

    p.last_activity = null;
    p.last_rake = 0;

    map[p.player_uid] = p;
  });

  data?.forEach(log=>{

    const player = map[log.player_uid];
    if(!player) return;

    const date = new Date(log.created_at);

    if(date >= thisWeek.start && date <= thisWeek.end)
      player.this_week += Number(log.rake);

    if(date >= lastWeek.start && date <= lastWeek.end)
      player.last_week += Number(log.rake);

    if(!player.last_activity || date > new Date(player.last_activity)){
      player.last_activity = log.created_at;
      player.last_rake = Number(log.rake);
    }

  });

  return players;
}


// =============================
// ‚≠ê ATTACH PLAYER STATE + NOTE
// =============================

async function attachPlayerState(players){

  const { data: seats } = await sb
    .from("seats")
    .select("player_uid,table_uid,seat_number,seated_at")
    .not("player_uid","is",null);

  const { data: notes } = await sb
    .from("agent_player_notes")
    .select("player_uid,note")
    .eq("agent_uid", agent_uid);

  const seatMap = {};
  const noteMap = {};

  notes?.forEach(n => {
    noteMap[String(n.player_uid)] = n.note;
  });

  seats?.forEach(seat=>{
    if(seat.player_uid){
      const uid = String(seat.player_uid);
      seatMap[uid] = {
        table: `${seat.table_uid}-${seat.seat_number}`,
        online: true,
        seated_at: seat.seated_at
      };
    }
  });

  players.forEach(p=>{

    const seatData = seatMap[String(p.player_uid)];

    p.is_online = Boolean(seatData);
    p.table_position = seatData?.table || "-";
    p.seated_at = seatData?.seated_at || null;
    p.note = noteMap[String(p.player_uid)] || "";
  });

  return players;
}


// Function PRO
const seatRefreshQueue = new Set();
let seatRefreshTimer = null;

function queueSeatRefresh(uid){

  if(!uid) return;

  seatRefreshQueue.add(String(uid));

  if(seatRefreshTimer) return;

  seatRefreshTimer = setTimeout(async ()=>{

    const uids = [...seatRefreshQueue];
    seatRefreshQueue.clear();
    seatRefreshTimer = null;

    const { data, error } = await sb
      .from("seats")
      .select("player_uid,table_uid,seat_number,seated_at")
      .in("player_uid", uids);

    if(error){
      console.error(error);
      return;
    }

    const seatMap = {};
    data?.forEach(s=>{
      seatMap[String(s.player_uid)] = s;
    });

    uids.forEach(uid=>{

      const player = allPlayers.find(
        p => String(p.player_uid) === uid
      );

      if(!player) return;

      const seat = seatMap[uid];

      if(seat){
        player.is_online = true;
        player.table_position = `${seat.table_uid}-${seat.seat_number}`;
        player.seated_at = seat.seated_at;
      }else{
        player.is_online = false;
        player.table_position = "-";
        player.seated_at = null;
      }

    });

    const onlineCount = allPlayers.filter(p=>p.is_online).length;

    totalPlayersEl.innerHTML =
      `<span style="color:#4ade80">${onlineCount}</span> / ${allPlayers.length}`;

    renderTable();

  }, 120);
}


// =============================
// SAVE NOTE (UPSERT)
// =============================

async function saveNote(player_uid, note){

  await sb
    .from("agent_player_notes")
    .upsert({
      agent_uid,
      player_uid,
      note
    },{
      onConflict:"agent_uid,player_uid"
    });
}


// ====== ‚úÖ LAST ACTIVITY: +$rake HH:mm:ss (24h) ======

function formatLastActivity(player){

  if(!player.last_activity) return "-";

  const diffMin = (Date.now() - new Date(player.last_activity)) / 60000;

  // qu√° 2h th√¨ ·∫©n
  if(diffMin >= 120) return "-";

  const amount = `+$${Number(player.last_rake||0).toLocaleString()}`;

  const time = new Date(player.last_activity).toLocaleTimeString('en-GB', {
    hour: '2-digit',
    minute: '2-digit',
    second: '2-digit',
    hour12: false
  });

  return `${amount} ${time}`;
}


// B·ªô ƒë·∫øm th·ªùi gian ng·ªìi 
function formatDuration(seatedAt){

  if(!seatedAt) return "-";

  const diff =
    (Date.now() - new Date(seatedAt)) / 60000;

  let color = "#4ade80";

  if(diff > 60) color = "#fbbf24";
  if(diff > 120) color = "#f87171";

  const h = Math.floor(diff / 60);
  const m = Math.floor(diff % 60);

  return `<span style="color:${color}">
            ${h}h ${m}m
          </span>`;
}

function updateSeatTimers(){

  if(currentView !== "players_state") return;

  document
    .querySelectorAll("tbody tr")
    .forEach(row=>{

      const uid = row.dataset.uid;

      const player = allPlayers.find(
        p => String(p.player_uid) === uid
      );

      if(!player) return;

      const cell = row.children[1];

      cell.innerHTML = player.is_online
        ? formatDuration(player.seated_at)
        : `<span style="color:#64748b">üí§</span>`;
    });
}

setInterval(updateSeatTimers, 1000);


// =============================
// ‚≠ê RENDER TABLE (MULTI MODE)
// =============================

function renderTable(){

  // PLAYER STATE MODE Total Players
  if(currentView === "players_state"){

    document.querySelector(".table thead").innerHTML = `
      <tr>
        <th>Player</th>
        <th>Status</th>
        <th>Table</th>
        <th>Note</th>
      </tr>
    `;

    const sortedPlayers = [...allPlayers].sort((a,b)=> b.is_online - a.is_online);

    playersBody.innerHTML = sortedPlayers.map(p=>`
      <tr data-uid="${p.player_uid}">
        <td>${p.player_uid}</td>
        <td style="font-weight:600;">
          ${
            p.is_online
              ? `<span style="color:#4ade80">${formatDuration(p.seated_at)}</span>`
              : `<span style="color:#64748b">üí§</span>`
          }
        </td>
        <td>
          ${p.table_position === "-" 
            ? "-"
            : `<span style="color:#4ade80;font-weight:600">${p.table_position}</span>`
          }
        </td>    
        <td>
          <input 
            value="${p.note || ""}"
            onchange="saveNote('${p.player_uid}', this.value)"
            style="
              background:transparent;
              border:1px solid rgba(255,255,255,.1);
              color:white;
              padding:6px;
              border-radius:6px;
              width:140px;
            "
          />
        </td>
      </tr>
    `).join("");

    return;
  }


  // RAKE MODES
  const metricText =
    currentView === "total"
      ? "Total Rake"
      : currentView === "this_week"
      ? "This Week"
      : "Last Week";

  document.querySelector(".table thead").innerHTML = `
    <tr>
      <th>Player ID</th>
      <th>${metricText}</th>
      ${ currentView !== "last_week" ? "<th>Last Activity</th>" : "" }
    </tr>
  `;

  const sorted = [...allPlayers].sort((a,b)=>{

    if(currentView === "total")
      return (b.total_rake||0)-(a.total_rake||0);

    if(currentView === "this_week")
      return (b.this_week||0)-(a.this_week||0);

    return (b.last_week||0)-(a.last_week||0);
  });

  playersBody.innerHTML = sorted.map(p=>{

    const value =
      currentView === "total"
        ? p.total_rake
        : currentView === "this_week"
        ? p.this_week
        : p.last_week;

    const isLive =
      p.last_activity &&
      (Date.now() - new Date(p.last_activity)) < 5000;

    return `
      <tr style="${
        isLive
          ? 'background:rgba(74,222,128,0.18);transition:.3s;'
          : ''
      }">
        <td>${p.player_uid}</td>
        <td>$${Number(value||0).toLocaleString()}</td>

        ${
          currentView !== "last_week"
            ? `
              <td style="color:#4ade80;font-weight:600;width:170px;">
                ${formatLastActivity(p)}
              </td>
            `
            : ""
        }
      </tr>
    `;
  }).join("");
}


// =============================
// DASHBOARD
// =============================

function scheduleWeekRollover(){

  if(weekRolloverTimer) clearTimeout(weekRolloverTimer);

  const now = getServerNow();

  // t√¨m Monday 00:00 k·∫ø ti·∫øp (server time)
  const day = now.getDay();
  const diffToNextMonday = (day === 0 ? 1 : 8 - day); // n·∫øu CN -> +1 ng√†y, c√≤n l·∫°i -> t·ªõi th·ª© 2 tu·∫ßn sau

  const nextMonday = new Date(now);
  nextMonday.setDate(now.getDate() + diffToNextMonday);
  nextMonday.setHours(0,0,0,0);

  const ms = nextMonday.getTime() - now.getTime();

  weekRolloverTimer = setTimeout(async ()=>{
    // t·ªõi m·ªëc tu·∫ßn m·ªõi: resync server time + reload dashboard (ƒë·ªÉ this_week/last_week ƒë√∫ng)
    await syncServerTime();

    // n·∫øu b·∫°n mu·ªën auto quay v·ªÅ This Week khi sang tu·∫ßn m·ªõi:
    currentView = "this_week";

    // update UI active card
    document.querySelectorAll(".card[data-view]").forEach(c=>c.classList.remove("active"));
    const thisWeekCard = document.querySelector('.card[data-view="this_week"]');
    if(thisWeekCard) thisWeekCard.classList.add("active");

    await loadDashboard();
    scheduleWeekRollover(); // schedule l·∫ßn k·∫ø ti·∫øp
  }, ms + 50); // +50ms buffer nh·ªè tr√°nh l·ªách ƒë√∫ng 00:00:00
}





async function loadDashboard(){

  agentNameEl.innerText = `UID: ${agent_uid}`;

  let players = await getPlayers();

  players = await attachWeeklyRake(players);
  players = await attachPlayerState(players);

  allPlayers = players;

  const onlineCount = players.filter(p => p.is_online === true).length;

  totalPlayersEl.innerHTML =
    onlineCount > 0
      ? `<span style="color:#4ade80"> ${onlineCount}</span> / ${players.length}`
      : `<span style="color:#9ca3af"> 0 </span> / ${players.length}`;

  const total = players.reduce((s,p)=>s+(p.total_rake||0),0);
  const thisWeek = players.reduce((s,p)=>s+(p.this_week||0),0);
  const lastWeek = players.reduce((s,p)=>s+(p.last_week||0),0);

  totalRakeEl.innerText = "$"+total.toLocaleString();
  thisWeekRakeEl.innerText = "$"+thisWeek.toLocaleString();
  lastWeekRakeEl.innerText = "$"+lastWeek.toLocaleString();

  renderTable();
}


// Realtime listerner b·∫£ng rake_logs
sb.channel('rake-live')
.on(
  'postgres_changes',
  {
    event: 'INSERT',
    schema: 'public',
    table: 'rake_logs',
    filter: `agent_uid=eq.${agent_uid}`
  },
  payload => {

    const log = payload.new;

    const player = allPlayers.find(
      p => p.player_uid === log.player_uid
    );

    if(!player) return;

    const rake = Number(log.rake);

    player.this_week += rake;
    player.total_rake += rake;

    // ‚≠ê update last activity ngay l·∫≠p t·ª©c
    player.last_activity = log.created_at;
    player.last_rake = rake;

    thisWeekRakeEl.innerText =
      "$" + allPlayers
        .reduce((s,p)=>s+(p.this_week||0),0)
        .toLocaleString();

    totalRakeEl.innerText =
      "$" + allPlayers
        .reduce((s,p)=>s+(p.total_rake||0),0)
        .toLocaleString();

    renderTable();
  }
)
.subscribe();


// realtime listener b·∫£ng seats
sb.channel('seats-live')
.on(
  'postgres_changes',
  {
    event:'*',
    schema:'public',
    table:'seats'
  },
  payload => {

    const uid =
      payload.new?.player_uid ||
      payload.old?.player_uid;

    if(uid){
      queueSeatRefresh(uid);
    }
  }
)
.subscribe();


// =============================
// CLICKABLE CARDS
// =============================

document.querySelectorAll(".card[data-view]")
.forEach(card=>{

  card.addEventListener("click",()=>{

    document
      .querySelectorAll(".card[data-view]")
      .forEach(c=>c.classList.remove("active"));

    card.classList.add("active");

    currentView = card.dataset.view;

    renderTable();
  });

});


// LOGOUT
function logout(){
  localStorage.removeItem("agent_uid");
  window.location.href = "./agent-login.html";
}


// START
(async ()=>{
  await syncServerTime();
  await loadDashboard();
  scheduleWeekRollover();
})();

setInterval(renderTable, 60000);

</script>


</body>
</html>
