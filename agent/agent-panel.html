<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Agent Panel</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:'Inter',sans-serif;}
body{background:#020617;color:white;min-height:100vh;}
.main{padding:24px;}
.topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:28px;}
.logout{padding:8px 14px;border-radius:10px;border:1px solid rgba(255,255,255,0.15);cursor:pointer;color:#f87171;}
.logout:hover{background:rgba(248,113,113,0.1);}
.agent-name{color:#94a3b8;margin-bottom:20px;}
.footer{margin-top:24px;text-align:center;color:#64748b;font-size:12px;}
.cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:16px;margin-bottom:32px;}
.card{padding:18px;border-radius:14px;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.06);}
.card[data-view]{cursor:pointer;transition:.2s;}
.card[data-view]:hover{transform:translateY(-4px);}
.card.active{border:1px solid #4ade80;background:rgba(74,222,128,0.08);}
.card-title{color:#94a3b8;font-size:13px;}
.card-value{font-size:24px;font-weight:600;margin-top:6px;}
.section-title{margin-bottom:12px;}
.table{width:100%;border-collapse:collapse;table-layout: fixed;}
.table th{text-align:left;padding:12px;color:#94a3b8;border-bottom:1px solid rgba(255,255,255,0.06);overflow:hidden;}
.table td{padding:14px 12px;border-bottom:1px solid rgba(255,255,255,0.04);overflow:hidden;}

.week-note{
  margin-top:-16px;
  margin-bottom:24px;
  font-size:12px;
  color:#64748b;
  text-align:right;
}

.note-view{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  cursor:pointer;
  padding:6px 8px;
  border-radius:8px;
  border:1px solid rgba(255,255,255,0.06);
  background:rgba(255,255,255,0.02);
}
.note-view:hover{
  border-color: rgba(255,255,255,0.14);
}
.note-text{
  max-width:220px;
  overflow:hidden;
  white-space:nowrap;
  text-overflow:ellipsis;
}
.note-edit{
  opacity:.8;
}
.note-view:hover .note-edit{
  opacity:1;
}

.truncate{
  display:inline-block;
  max-width:100%;
  overflow:hidden;
  white-space:nowrap;
  text-overflow:ellipsis;
  vertical-align:bottom;
}

.table td { overflow:hidden; }
.table-slot.online{ color:#4ade80; font-weight:600; }
.table-slot.offline{ color:#64748b; }

/* ===== RIVEBASE BRAND (panel topbar) — additive ===== */
.brandbar{
  display:flex;
  align-items:center;
  gap:12px;
  min-width:0;
}

.rb-logo{
  width:34px;
  height:34px;
  border-radius:12px;
  flex:0 0 auto;
  background:
    radial-gradient(12px 12px at 30% 30%, rgba(255,255,255,.55), transparent 60%),
    linear-gradient(135deg, rgba(124,58,237,.95), rgba(34,211,238,.85));
  border:1px solid rgba(255,255,255,.18);
  box-shadow:0 12px 35px rgba(124,58,237,.18);
}

.brandtext{
  display:flex;
  flex-direction:column;
  gap:2px;
  min-width:0;
}

.brandname{
  font-size:16px;
  font-weight:700;
  letter-spacing:.2px;
  line-height:1.1;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

.brandtag{
  font-size:12px;
  color:#94a3b8;
  line-height:1.2;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

/* Mobile: ẩn tagline để không vỡ topbar */
@media (max-width:420px){
  .brandtag{display:none;}
}


</style>
</head>
<body>

<div class="main">
  <div class="topbar">
  <div class="brandbar">
    <div class="rb-logo" aria-hidden="true"></div>
    <div class="brandtext">
      <div class="brandname">Rivebase</div>
      <div class="brandtag">Realtime Rake Counter System</div>
    </div>
  </div>

  <div class="logout" onclick="logout()">Logout</div>
</div>


  <div class="agent-name" id="agentName"></div>

  <div class="cards">
    <div class="card">
      <div class="card-title">Total Players</div>
      <div class="card-value" id="totalPlayers">--</div>
    </div>

    <div class="card" data-view="total">
      <div class="card-title">Total Rake</div>
      <div class="card-value" id="totalRake">--</div>
    </div>

    <div class="card active" data-view="this_week">
      <div class="card-title">This Week</div>
      <div class="card-value" id="thisWeekRake">--</div>
    </div>

    <div class="card" data-view="last_week">
      <div class="card-title">Last Week</div>
      <div class="card-value" id="lastWeekRake">--</div>
    </div>
  </div>

    <div class="week-note">
  Week starts Monday 00:00 UTC (07:00 AM Vietnam time)
</div>


  <div class="section">
    <div class="section-title">Your Players</div>
    <table class="table">
      <thead>
        <tr>
          <th>Player ID</th>
          <th id="tableMetric">This Week</th>
        </tr>
      </thead>
      <tbody id="playersBody"></tbody>
    </table>
  </div>

  <div class="footer">© 2026 Rivebase • Internal Operations</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
// =====================
// INIT
// =====================
const sb = supabase.createClient(
  "https://ymtmipkmknnsqleahlmi.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InltdG1pcGtta25uc3FsZWFobG1pIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAwOTU1MjUsImV4cCI6MjA4NTY3MTUyNX0.7pEza-TKBKJ_xqdBu93nLo-PRaHDcDIxW-bjZnrFJxw"
);

const agent_uid = localStorage.getItem("agent_uid");
if(!agent_uid) window.location.href = "./agent-login.html";

// =====================
// STATE GLOBAL
// =====================
let allPlayers = [];
let currentView = "this_week";

let serverClockSkewMs = 0;      // serverNow - clientNow
let prodRolloverTimer = null;   // production
let playersStateShow = "table"; // "table" | "duration"




// =====================
// DOM
// =====================
const playersBody = document.getElementById("playersBody");
const totalPlayersEl = document.getElementById("totalPlayers");
const totalRakeEl = document.getElementById("totalRake");
const thisWeekRakeEl = document.getElementById("thisWeekRake");
const lastWeekRakeEl = document.getElementById("lastWeekRake");
const agentNameEl = document.getElementById("agentName");

// ⭐ MAKE TOTAL PLAYERS CLICKABLE
document.querySelector("#totalPlayers")
  .closest(".card")
  .setAttribute("data-view","players_state");

// =====================
// SERVER TIME SYNC
// =====================
async function syncServerTime(){
  const { data, error } = await sb.rpc("get_server_now");
  if(error){
    console.error("get_server_now error:", error);
    serverClockSkewMs = 0;
    return;
  }
  const sNow = new Date(data);
  const cNow = new Date();
  serverClockSkewMs = sNow.getTime() - cNow.getTime();
}

function getServerNow(){
  return new Date(Date.now() + serverClockSkewMs);
}

// =====================
// FETCH PLAYERS
// =====================
async function getPlayers(){
  const { data, error } = await sb
    .from("players")
    .select("player_uid,total_rake,note,percent_rake")
    .eq("agent_uid", agent_uid);

  if(error){
    console.error(error);
    return [];
  }
  return data || [];
}

async function getAgent(){
  const { data, error } = await sb
    .from("agents")
    .select("agent_uid,name")
    .eq("agent_uid", agent_uid)
    .maybeSingle();

  if(error){
    console.error("getAgent error:", error);
    return null;
  }
  return data;
}
//======================
// SAVE PERCENT RAKE
//======================
async function savePercentRake(player_uid, percent_rake){
  const n = Number(percent_rake);
  const clamped = Math.max(10, Math.min(50, Number.isFinite(n) ? n : 10));

  const { error } = await sb
    .from("players")
    .update({ percent_rake: clamped })
    .eq("player_uid", player_uid)
    .eq("agent_uid", agent_uid);

  if(error) console.error("savePercentRake error:", error);
  return clamped;
}


async function onPercentBlur(player_uid, value, el){
  const raw = String(value ?? "").trim();

  // nếu bỏ trống -> restore số cũ
  if(raw === ""){
    if(el && el.dataset.old != null) el.value = el.dataset.old;
  }

  const n = Number(el ? el.value : raw);
  const pct = Math.max(10, Math.min(50, Number.isFinite(n) ? n : 10));

  const { error } = await sb
    .from("players")
    .update({ percent_rake: pct })
    .eq("player_uid", player_uid)
    .eq("agent_uid", agent_uid);

  if(error){
    console.error("onPercentBlur error:", error);
  }else{
    const p = allPlayers.find(x => String(x.player_uid) === String(player_uid));
    if(p) p.percent_rake = pct;
  }

  // reset để lần tap sau xoá tiếp được
  if(el) el.dataset.cleared = "0";

  renderTable();
}





// =====================
// WEEK RANGE UTC (PROD)
// =====================
function getWeekRangeUTC(offset = 0, baseDate = null){
  const now = baseDate ? new Date(baseDate) : getServerNow();

  const day = now.getUTCDay(); // UTC day
  const diffToMonday = (day === 0 ? -6 : 1 - day);

  const monday = new Date(now);
  monday.setUTCDate(now.getUTCDate() + diffToMonday + offset * 7);
  monday.setUTCHours(0,0,0,0);

  const sunday = new Date(monday);
  sunday.setUTCDate(monday.getUTCDate() + 6);
  sunday.setUTCHours(23,59,59,999);

  return { start: monday, end: sunday };
}


// BẢNG CHÍNH THỨC (UTC THEO TUẦN)

async function getWeekRangesUTC(){
  const { data, error } = await sb.rpc("get_week_ranges_utc");
  if(error){
    console.error("get_week_ranges_utc error:", error);
    return null;
  }
  return {
    utc_now: new Date(data.utc_now),
    this_start: new Date(data.this_week_start),
    this_end: new Date(data.this_week_end),
    last_start: new Date(data.last_week_start),
    last_end: new Date(data.last_week_end),
  };
}

function scheduleWeekRolloverUTC(nextUTCDate){
  if(prodRolloverTimer) clearTimeout(prodRolloverTimer);

  // canh theo server time (skew) để bám DB
  const ms = nextUTCDate.getTime() - getServerNow().getTime();

  prodRolloverTimer = setTimeout(async ()=>{
    // tới Monday 00:00 UTC -> reload dashboard cho chuẩn tuần mới
    currentView = "this_week";

    document.querySelectorAll(".card[data-view]").forEach(c=>c.classList.remove("active"));
    const thisWeekCard = document.querySelector('.card[data-view="this_week"]');
    if(thisWeekCard) thisWeekCard.classList.add("active");

    await loadDashboard();
  }, Math.max(1000, ms + 200));
}




// =====================
// ATTACH WEEKLY RAKE
// =====================
async function attachWeeklyRake(players){
  const { data, error } = await sb
    .from("rake_logs")
    .select("player_uid,rake,created_at")
    .eq("agent_uid", agent_uid);

  if(error){
    console.error(error);
    return players;
  }

  let thisWeek, lastWeek;

const r = await getWeekRangesUTC();

if(r){
  // schedule đúng mốc tuần mới: this_start + 7 ngày (Monday 00:00 UTC tuần sau)
  const nextMondayUTC = new Date(r.this_start.getTime() + 7 * 24 * 60 * 60 * 1000);
  scheduleWeekRolloverUTC(nextMondayUTC);

  thisWeek = { start: r.this_start, end: r.this_end };
  lastWeek = { start: r.last_start, end: r.last_end };
}else{
  // fallback nếu RPC fail: dùng serverNow tính (kém chuẩn hơn)
  const base = getServerNow();
  thisWeek = getWeekRangeUTC(0, base);
  lastWeek = getWeekRangeUTC(-1, base);
}


  const map = {};
  players.forEach(p=>{
    p.this_week = 0;
    p.last_week = 0;
    p.last_activity = null;
    p.last_rake = 0;
    map[p.player_uid] = p;
  });

  data?.forEach(log=>{
    const player = map[log.player_uid];
    if(!player) return;

    const date = new Date(log.created_at);

    if(date >= thisWeek.start && date <= thisWeek.end) player.this_week += Number(log.rake);
    if(date >= lastWeek.start && date <= lastWeek.end) player.last_week += Number(log.rake);

    if(!player.last_activity || date > new Date(player.last_activity)){
      player.last_activity = log.created_at;
      player.last_rake = Number(log.rake);
    }
  });

  return players;
}

// =====================
// ATTACH PLAYER STATE + NOTE
// =====================
async function attachPlayerState(players){
const { data: seats, error: seatsErr } = await sb
  .from("seats")
  .select("player_uid,table_uid,seat_number,seated_at")
  .not("player_uid","is",null);

if(seatsErr){
  console.error("SEATS ERROR:", seatsErr);
}

console.log("seats loaded:", seats?.length);

  const seatMap = {};
  const noteMap = {};


  seats?.forEach(seat=>{
    if(seat.player_uid){
      const uid = String(seat.player_uid);
      seatMap[uid] = {
        table: `${seat.table_uid}-${seat.seat_number}`,
        seated_at: seat.seated_at
      };
    }
  });

players.forEach(p=>{
  const seatData = seatMap[String(p.player_uid)];
  p.is_online = Boolean(seatData);
  p.table_position = seatData?.table || "-";
  p.seated_at = seatData?.seated_at || null;
  // note đã có sẵn từ getPlayers(): p.note
});


  return players;
}

// =====================
// SAVE NOTE (UPSERT)
// =====================
async function saveNote(player_uid, note){
  const { error } = await sb
    .from("players")
    .update({ note })
    .eq("player_uid", player_uid)
    .eq("agent_uid", agent_uid);

  if(error) console.error("save Note error:", error);
}

function escapeHtml(str){
  return String(str)
    .replace(/&/g,"&amp;")
    .replace(/</g,"&lt;")
    .replace(/>/g,"&gt;")
    .replace(/"/g,"&quot;")
    .replace(/'/g,"&#39;");
}
function escapeAttr(str){
  // dùng cho value=""
  return escapeHtml(str).replace(/"/g,"&quot;");
}

function startEditNote(player_uid){
  const cell = document.querySelector(`.note-cell[data-uid="${player_uid}"]`);
  if(!cell) return;

  cell.querySelector(".note-view").style.display = "none";
  cell.querySelector(".note-editbox").style.display = "block";

  const input = document.getElementById(`noteInput-${player_uid}`);
  if(input){
    input.focus();
    input.select();
    // lưu note cũ để ESC rollback
    input.dataset.old = input.value;
  }
}

function stopEditNote(player_uid){
  const cell = document.querySelector(`.note-cell[data-uid="${player_uid}"]`);
  if(!cell) return;

  cell.querySelector(".note-editbox").style.display = "none";
  cell.querySelector(".note-view").style.display = "flex";
}

async function commitNote(player_uid){
  const input = document.getElementById(`noteInput-${player_uid}`);
  if(!input) return;

  const newNote = input.value;

  // update local state trước cho UI mượt
  const player = allPlayers.find(p => String(p.player_uid) === String(player_uid));
  if(player) player.note = newNote;

  await saveNote(player_uid, newNote);

  // render lại table để view mode hiện note mới
  renderTable();
}

function handleNoteKey(e, player_uid){
  if(e.key === "Enter"){
    e.preventDefault();
    commitNote(player_uid);
  }
  if(e.key === "Escape"){
    e.preventDefault();
    const input = document.getElementById(`noteInput-${player_uid}`);
    if(input) input.value = input.dataset.old || "";
    // rollback local state
    const player = allPlayers.find(p => String(p.player_uid) === String(player_uid));
    if(player) player.note = input.value;

    renderTable();
  }
}





// =====================
// UI HELPERS
// =====================
function formatLastActivity(player){
  if(!player.last_activity) return "-";

  const diffMin = (Date.now() - new Date(player.last_activity)) / 60000;
  if(diffMin >= 120) return "-";

  const amount = `+$${Number(player.last_rake||0).toLocaleString()}`;
  const time = new Date(player.last_activity).toLocaleTimeString('en-GB', {
    hour:'2-digit', minute:'2-digit', second:'2-digit', hour12:false
  });

  return `${amount} ${time}`;
}

function formatDuration(seatedAt){
  if(!seatedAt) return "-";

  const diff = (Date.now() - new Date(seatedAt)) / 60000;

  let color = "#4ade80";
  if(diff > 60) color = "#fbbf24";
  if(diff > 120) color = "#f87171";

  const h = Math.floor(diff / 60);
  const m = Math.floor(diff % 60);

  return `<span style="color:${color}">${h}h ${m}m</span>`;
}

function updatePlayersStateTableCell(){
  if(currentView !== "players_state") return;

  document.querySelectorAll("tbody tr").forEach(row=>{
    const uid = row.dataset.uid;
    const player = allPlayers.find(p => String(p.player_uid) === String(uid));
    if(!player) return;

    // tìm đúng cell Table theo class, không dùng children[index]
    const slot = row.querySelector(".table-slot");
    if(!slot) return;

    if(!player.is_online){
      slot.classList.remove("online");
      slot.classList.add("offline");
      slot.innerHTML = "-";
      return;
    }

    if(playersStateShow === "duration"){
      slot.classList.add("online");
      slot.classList.remove("offline");
      slot.innerHTML = formatDuration(player.seated_at); // có màu theo hàm formatDuration
    }else{
      slot.classList.add("online");
      slot.classList.remove("offline");
      slot.textContent = player.table_position || "-"; // ví dụ A1-1
    }
  });
}

// update mỗi 1s để duration chạy mượt (khi đang ở mode duration)
setInterval(()=> {
  if(currentView === "players_state" && playersStateShow === "duration"){
    updatePlayersStateTableCell();
  }
}, 1000);

// đổi qua lại Table <-> Duration mỗi 5s
setInterval(()=> {
  if(currentView !== "players_state") return;
  playersStateShow = (playersStateShow === "table") ? "duration" : "table";
  updatePlayersStateTableCell();
}, 5000);

function onPctTap(el){
  if(!el) return;

  // chỉ xoá lần đầu khi vừa focus (tránh tap lại xoá tiếp khi đang gõ)
  if(el.dataset.cleared === "1") return;

  el.dataset.old = el.value;
  el.value = "";
  el.dataset.cleared = "1";

  // iOS: đảm bảo focus + hiện keyboard
  setTimeout(()=> {
    try{
      el.focus();
      el.select();
    }catch(e){}
  }, 0);
}






// =====================
// SEAT REALTIME (batched refresh)
// =====================
const seatRefreshQueue = new Set();
let seatRefreshTimer = null;

function queueSeatRefresh(uid){
  if(!uid) return;

  seatRefreshQueue.add(String(uid));
  if(seatRefreshTimer) return;

  seatRefreshTimer = setTimeout(async ()=>{
    const uids = [...seatRefreshQueue];
    seatRefreshQueue.clear();
    seatRefreshTimer = null;

    const { data, error } = await sb
      .from("seats")
      .select("player_uid,table_uid,seat_number,seated_at")
      .in("player_uid", uids);

    if(error){
      console.error(error);
      return;
    }

    const seatMap = {};
    data?.forEach(s => seatMap[String(s.player_uid)] = s);

    uids.forEach(uid=>{
      const player = allPlayers.find(p => String(p.player_uid) === uid);
      if(!player) return;

      const seat = seatMap[uid];
      if(seat){
        player.is_online = true;
        player.table_position = `${seat.table_uid}-${seat.seat_number}`;
        player.seated_at = seat.seated_at;
      }else{
        player.is_online = false;
        player.table_position = "-";
        player.seated_at = null;
      }
    });

    const onlineCount = allPlayers.filter(p=>p.is_online).length;
    totalPlayersEl.innerHTML =
      `<span style="color:#4ade80">${onlineCount}</span> / ${allPlayers.length}`;

    renderTable();
  }, 120);
}

// =====================
// RENDER TABLE
// =====================

  // PLAYER STATE MODE

function renderTable(){
  if(currentView === "players_state"){
    document.querySelector(".table thead").innerHTML = `
      <tr>
        <th style="width:35%;">Player</th>
        <th style="width:25%;">Table</th>
        <th style="width:40%;">Note</th>
      </tr>
    `;

    const sortedPlayers = [...allPlayers].sort((a,b)=> b.is_online - a.is_online);

    playersBody.innerHTML = sortedPlayers.map(p=>`
      <tr data-uid="${p.player_uid}">
        <td>
          <span style="font-weight:600">${p.player_uid}</span>
          ${p.is_online ? ` <span style="color:#4ade80;">●</span>` : ` <span style="color:#64748b;">●</span>`}
        </td>

        <td>
          <span class="table-slot ${p.is_online ? 'online' : 'offline'}">
            ${p.table_position === "-" ? "-" : p.table_position}
          </span>
        </td>

        <td>
          <div class="note-cell" data-uid="${p.player_uid}">
            <div class="note-view" onclick="startEditNote('${p.player_uid}')">
              <span class="note-text">
                ${(p.note || "").trim()
                  ? escapeHtml(p.note)
                  : `<span style="color:#64748b">Add note…</span>`}
              </span>
              <span class="note-edit">✏️</span>
            </div>

            <div class="note-editbox" style="display:none;">
              <input
                id="noteInput-${p.player_uid}"
                value="${escapeAttr(p.note || "")}"
                onkeydown="handleNoteKey(event,'${p.player_uid}')"
                onblur="commitNote('${p.player_uid}')"
                style="
                  background:transparent;
                  border:1px solid rgba(255,255,255,.14);
                  color:white;
                  padding:6px 8px;
                  border-radius:8px;
                  width:180px;
                  outline:none;
                "
              />
            </div>
          </div>
        </td>
      </tr>
    `).join("");

    // ✅ sau khi render xong mới update table/duration
    updatePlayersStateTableCell();
    return;
  }



  // RAKE MODES
  
const metricText =
  currentView === "total" ? "Total Rake" :
  currentView === "this_week" ? "This Week" :
  "Last Week";

  const isLastWeek = currentView === "last_week";

document.querySelector(".table thead").innerHTML = `
  <tr>
    <th style="width:${isLastWeek ? "30%" : "30%"};">Player</th>
    <th style="width:${isLastWeek ? "15%" : "15%"};">${metricText}</th>
    ${
      isLastWeek
        ? `<th style="width:20%;">%Rake</th>
           <th style="width:15%;">Rake Back</th>`
        : `<th style="width:30%;">Record</th>`
    }
        
  </tr>
`;


  const sorted = [...allPlayers].sort((a,b)=>{
    if(currentView === "total") return (b.total_rake||0)-(a.total_rake||0);
    if(currentView === "this_week") return (b.this_week||0)-(a.this_week||0);
    return (b.last_week||0)-(a.last_week||0);
  });


playersBody.innerHTML = sorted.map(p=>{
  const value =
    currentView === "total" ? p.total_rake :
    currentView === "this_week" ? p.this_week :
    p.last_week;

  const isLive = p.last_activity && (Date.now() - new Date(p.last_activity)) < 5000;

  const pct = Number.isFinite(Number(p.percent_rake)) ? Number(p.percent_rake) : 10;
  const rakeback = isLastWeek ? (Number(value||0) * pct / 100) : 0;

  return `
    <tr style="${isLive ? 'background:rgba(74,222,128,0.18);transition:.3s;' : ''}">
      <td>
        <span style="font-weight:600">${p.player_uid}</span>
        ${
          (p.note || "").trim()
            ? ` <span class="truncate" style="color:#94a3b8; max-width:65%;">(${escapeHtml(p.note)})</span>`
            : ""
        }
      </td>

      <td>$${Number(value||0).toLocaleString()}</td>

      ${
        isLastWeek
          ? `
            <td>
          <input
  type="number"
  inputmode="numeric"
  pattern="[0-9]*"
  min="10"
  max="50"
  step="1"
  value="${pct}"
  onclick="onPctTap(this)"
  onfocus="onPctTap(this)"
  onblur="onPercentBlur('${p.player_uid}', this.value, this)"
  style="
    width:48px;
    min-width:48px;
    text-align:center;
    background:transparent;
    border:1px solid rgba(255,255,255,.14);
    color:white;
    padding:4px 6px;
    border-radius:6px;
    outline:none;
  "
/>
              <span style="color:#94a3b8;">%</span>
            </td>
            <td style="font-weight:600; color:#4ade80;">
              $${Number(rakeback||0).toLocaleString()}
            </td>
          `
          : `
            <td style="color:#4ade80;font-weight:600;">
              <span class="truncate" style="max-width:100%; display:inline-block;">
                ${formatLastActivity(p)}
              </span>
            </td>
          `
      }
    </tr>
  `;
}).join("");


}


// =====================
// DASHBOARD
// =====================
async function loadDashboard(){

    await syncServerTime();



  const agent = await getAgent();
  console.log("agent fetched:", agent);
  agentNameEl.innerText = `Agent: ${agent?.name || agent_uid}`;

  let players = await getPlayers();
  players = await attachWeeklyRake(players);
  players = await attachPlayerState(players);

  allPlayers = players;

  const onlineCount = players.filter(p => p.is_online === true).length;
  totalPlayersEl.innerHTML =
    onlineCount > 0
      ? `<span style="color:#4ade80">${onlineCount}</span> / ${players.length}`
      : `<span style="color:#9ca3af">0</span> / ${players.length}`;

  const total = players.reduce((s,p)=>s+(p.total_rake||0),0);
  const thisWeek = players.reduce((s,p)=>s+(p.this_week||0),0);
  const lastWeek = players.reduce((s,p)=>s+(p.last_week||0),0);

  totalRakeEl.innerText = "$"+total.toLocaleString();
  thisWeekRakeEl.innerText = "$"+thisWeek.toLocaleString();
  lastWeekRakeEl.innerText = "$"+lastWeek.toLocaleString();

  renderTable();
}

// =====================
// REALTIME: rake_logs
// =====================
sb.channel('rake-live')
.on(
  'postgres_changes',
  {
    event: 'INSERT',
    schema: 'public',
    table: 'rake_logs',
    filter: `agent_uid=eq.${agent_uid}`
  },
  payload => {
  
    const log = payload.new;
    const player = allPlayers.find(p => p.player_uid === log.player_uid);
    if(!player) return;

    const rake = Number(log.rake);

    player.this_week += rake;
    player.total_rake += rake;

    player.last_activity = log.created_at;
    player.last_rake = rake;

    thisWeekRakeEl.innerText =
      "$" + allPlayers.reduce((s,p)=>s+(p.this_week||0),0).toLocaleString();

    totalRakeEl.innerText =
      "$" + allPlayers.reduce((s,p)=>s+(p.total_rake||0),0).toLocaleString();

    renderTable();
  }
)
.subscribe();

// =====================
// REALTIME: seats
// =====================
sb.channel('seats-live')
.on(
  'postgres_changes',
  { event:'*', schema:'public', table:'seats' },
  payload => {
    const uid = payload.new?.player_uid || payload.old?.player_uid;
    if(uid) queueSeatRefresh(uid);
  }
)
.subscribe();

// =====================
// CLICKABLE CARDS
// =====================
document.querySelectorAll(".card[data-view]").forEach(card=>{
  card.addEventListener("click",()=>{
    document.querySelectorAll(".card[data-view]").forEach(c=>c.classList.remove("active"));
    card.classList.add("active");
    currentView = card.dataset.view;
    renderTable();
  });
});

// =====================
// LOGOUT
// =====================
function logout(){
  localStorage.removeItem("agent_uid");
  window.location.href = "./agent-login.html";
}

// =====================
// START
// =====================
(async ()=>{
  
  await loadDashboard();
  
})();

setInterval(renderTable, 60000);
</script>

</body>
</html>
