<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>Table Counter</title>

<style>
/* ===== GLOBAL LOCK ===== */
html, body {
  margin: 0;
  padding: 0;
  height: 100%;
  overflow: hidden;
  overscroll-behavior: none;
  touch-action: manipulation;
  background: #0e0e11;
  color: #fff;
  font-family: system-ui, sans-serif;
}

input, button { font-size: 16px; }

/* ===== LOGIN ===== */
#loginView {
  position: fixed;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  background: #0e0e11;
  z-index: 1000;
}
#loginBox {
  width: 300px;
  background: #000;
  padding: 16px;
    border-radius: 14px;
  text-align: center;
}

#loginBox select {
  width: 100%;
  padding: 16px;
  border-radius: 8px;
  border: none;
  margin-bottom: 14px;
  font-size: 16px;
}

/* PIN */
.pin-display {
  display: flex;
  justify-content: space-between;
  margin: 16px 0;
}
.pin-dot {
  width: 16px;
  height: 16px;
  border: 2px solid #444;
  border-radius: 50%;
}
.pin-dot.filled {
  background: #0a84ff;
  border-color: #0a84ff;
}

/* Keypad */
.keypad {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 10px;
}
.keypad button {
  padding: 14px;
  font-size: 18px;
  border-radius: 10px;
  border: none;
  background: #1f2937;
  color: #fff;
}
.keypad button:active {
  background: #374151;
}

/* ===== PANEL ===== */
#panelView {
  display: none;
  width: 100%;
  height: 100%;
}

/* ===== Chia App l√†m 2 =====*/
.app{
  display:flex;
  flex-direction:column;
  height:100dvh;
}

/* ===== Control Panel====*/
.control-panel{
  flex:4;
  background:#111;
  color:white;
  padding:16px;
  border-top:3px solid #222;
  border-radius:18px 18px 0 0;
  box-shadow:0 -8px 30px rgba(0,0,0,.45);

}


/* ===== TABLE ===== */
.table-area {
  flex:6;
  display: flex;
  align-items: center;
  justify-content: center;
  
}


.table {
  position: relative;
  width: 270px;
  height: 190px;
  border-radius: 200px;
  background: radial-gradient(circle, #1c1c1c, #0f0f0f 70%);
  border: 4px solid #2a2a2a;
}
.seat {
  position: absolute;
  width: 60px;
  height: 60px;
  border-radius: 50%;
  background: #1f2937;
  border: 2px solid #374151;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  font-weight: 600;
  cursor: pointer;
  user-select: none;
  -webkit-user-select: none;
  -webkit-touch-callout: none;
  touch-action: none;
}
.seat.occupied {
  background: #0a84ff;
  border-color: #0a84ff;
}
.seat small {
  font-size: 10px;
  opacity: .9;
}

.seat.selected {
  background: #f59e0b;      /* v√†ng cam */
  border-color: #fbbf24;
  color: #000;
  box-shadow: 0 0 0 3px rgba(245,158,11,.4);
}

.slide-container {
  width: 100%;
  max-width: 360px;
  margin: 16px auto;
}

.slide-track {
  position: relative;
  height: 54px;
  background: #222;
  border-radius: 30px;
  overflow: hidden;
  user-select: none;
}

.slide-text {
  position: absolute;
  width: 100%;
  height: 100%;
  color: #aaa;
  font-size: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
  pointer-events: none;
}

.slide-thumb {
  position: absolute;
  top: 4px;
  left: 4px;
  width: 46px;
  height: 46px;
  background: #fff;
  border-radius: 50%;
  box-shadow: 0 2px 8px rgba(0,0,0,0.4);
  cursor: pointer;
  touch-action: none;
}

.slide-track.disabled {
  opacity: .4;
}





</style>
</head>

<body>

<!-- ===== LOGIN VIEW ===== -->
<div id="loginView">
  <div id="loginBox">
    <h3 style="margin:0 0 10px">Table Counter</h3>

    <select id="tableSelect">
      <option value="">-- Ch·ªçn b√†n --</option>

    </select>

    <div class="pin-display">
      <div class="pin-dot"></div>
      <div class="pin-dot"></div>
      <div class="pin-dot"></div>
      <div class="pin-dot"></div>
    </div>

    <div class="keypad">
      <button onclick="press(1)">1</button>
      <button onclick="press(2)">2</button>
      <button onclick="press(3)">3</button>

      <button onclick="press(4)">4</button>
      <button onclick="press(5)">5</button>
      <button onclick="press(6)">6</button>

      <button onclick="press(7)">7</button>
      <button onclick="press(8)">8</button>
      <button onclick="press(9)">9</button>

      <button onclick="backPin()">‚Üê</button>
      <button onclick="press(0)">0</button>
      <button onclick="submitLogin()">OK</button>
    </div>
  </div>
</div>

<!-- ===== PANEL VIEW ===== -->
<div id="panelView">
    <div class="app">
        <div class="table-area">
            <div class="table" id="table"></div>
        </div>

        <div class="control-panel">
          <!-- rake panel ƒë·∫∑t ·ªü ƒë√¢y -->
            <div id="rakePanel" style="text-align:center; margin-top:20px;">

  <div id="selectedSeat" style="font-size:22px; font-weight:600;">
    No seat selected
  </div>

  <div id="rakeAmount" style="
      font-size:72px;
      font-weight:800;
      margin:20px 0;">
      $0
  </div>

  <button class="rake-btn" onclick="addRake(1)">+$1</button>
  <button class="rake-btn" onclick="addRake(5)">+$5</button>
  <button class="rake-btn" onclick="undoRake()">‚Üê Back</button>

  <br><br>

  <button id="nextHandBtn"
          onclick="nextHand()"
          style="display: none">
    Next Hand
 
  </button>
  <!-- thanh slide--> 
  <div class="slide-container">
  <div class="slide-track">
    <span class="slide-text" id="slideText">Slide to Next Hand</span>
    <div class="slide-thumb" id="slideThumb"></div>
  </div>
</div>

</div>
        <!--Modal x√°c nh·∫≠n rake =0 -->
        <div id="noRakeModal" style="
display:none;
position:fixed;
top:0;
left:0;
right:0;
bottom:0;
background:rgba(0,0,0,0.6);
align-items:center;
justify-content:center;">

  <div style="
  background:white;
  padding:40px;
  border-radius:16px;
  text-align:center;">

    <h2>NO RAKE</h2>
    <p>Close this hand with $0?</p>

    <button onclick="confirmNoRake()"
      style="font-size:20px; padding:12px 24px;">
      Next Hand
    </button>

    <button onclick="closeModal()"
      style="font-size:20px; padding:12px 24px;">
      Back
    </button>

  </div>
</div>

        
        
        </div>

    </div>





</div>

<!-- ===== QR MODAL ===== -->
<div id="qrModal" style="
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.85);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9999;
">
  <div style="width:260px;background:#000;padding:12px;border-radius:12px">
    <div id="qr-reader" style="width:100%; min-height:240px"></div>
    <button id="closeQR" style="
      width:100%;
      margin-top:10px;
      padding:10px;
      border:none;
      border-radius:8px;
      background:#374151;
      color:#fff;
      font-size:16px;
    ">Cancel</button>
  </div>
</div>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="https://unpkg.com/html5-qrcode"></script>

<script>
/* ===== LOCK ZOOM ===== */
document.addEventListener('gesturestart', e => e.preventDefault());
document.addEventListener('gesturechange', e => e.preventDefault());
document.addEventListener('gestureend', e => e.preventDefault());



/* ===== SUPABASE ===== */
const SUPABASE_URL = 'https://ymtmipkmknnsqleahlmi.supabase.co'
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InltdG1pcGtta25uc3FsZWFobG1pIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAwOTU1MjUsImV4cCI6MjA4NTY3MTUyNX0.7pEza-TKBKJ_xqdBu93nLo-PRaHDcDIxW-bjZnrFJxw'
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY)

loadTables()


/* ===== LOGIN WITH PIN ===== */
let TABLE_UID = null
let pin = ''

function press(n) {
  if (pin.length >= 4) return;

  pin += n;
  updateDots();

  // ‚úÖ Auto login khi ƒë·ªß 4 s·ªë (n·∫øu ƒë√£ ch·ªçn b√†n)
  if (pin.length === 4) {
    const table = document.getElementById('tableSelect')?.value;
    if (table) submitLogin();
  }
}

function backPin() {
  pin = pin.slice(0, -1)
  updateDots()
}

function updateDots() {
  document.querySelectorAll('.pin-dot').forEach((d, i) => {
    d.classList.toggle('filled', i < pin.length)
  })
}

/* === load tables === */

async function loadTables() {
  const { data, error } = await sb
    .from('tables')
    .select('table_uid')
    .eq('active', true)
    .order('table_uid')

  if (error) {
    alert('Kh√¥ng load ƒë∆∞·ª£c danh s√°ch b√†n')
    return
  }

  const select = document.getElementById('tableSelect')

  data.forEach(row => {
    const opt = document.createElement('option')
    opt.value = row.table_uid        // A1
    opt.textContent = 'B√†n ' + row.table_uid
    select.appendChild(opt)
  })
}

document.getElementById('tableSelect').addEventListener('change', () => {
  if (pin.length === 4) submitLogin();
});



async function submitLogin() {
  const table = document.getElementById('tableSelect').value
  if (!table) return alert('Ch∆∞a ch·ªçn b√†n')
  if (pin.length !== 4) return alert('PIN ph·∫£i ƒë·ªß 4 s·ªë')

  const { data, error } = await sb
    .from('tables')
    .select('table_uid, pin_hash, active')
    .eq('table_uid', table)
    .single()

  if (error || !data) {
    resetPin()
    return alert('B√†n kh√¥ng t·ªìn t·∫°i')
  }

  if (!data.active) {
    resetPin()
    return alert('B√†n ƒëang b·ªã kh√≥a')
  }

  // ‚ö†Ô∏è so s√°nh plain text (t·∫°m th·ªùi)
  if (data.pin_hash !== pin) {
    resetPin()
    return alert('Sai PIN')
  }

  // ‚úÖ LOGIN OK
  TABLE_UID = data.table_uid
  localStorage.setItem("table_uid", TABLE_UID);
  document.getElementById('loginView').style.display = 'none'
  document.getElementById('panelView').style.display = 'block'

  initPanel()
}

function resetPin() {
  pin = ''
  document.querySelectorAll('.pin-dot')
    .forEach(d => d.classList.remove('filled'))
}




/* ===== CONFIG ===== */
const SEAT_COUNT = 9
const TOP_SEAT = 5
const SEAT_SIZE = 60
const TABLE_BORDER = 4
const SAFE_PADDING = 8
const HOLD_TIME = 700

// Bi·∫øn global
let rakeTotal = 0;
let rakeHistory = [];
let selectedPlayerId = null;
let selectedSeatLabel = "";
let selectedSeatNumber = null; //ch·ªçn gh·∫ø
let isSubmitting = false;

const seatState = {}
const seats = {}
let holdTimer = null
let didHold = false //th√™m bi·∫øn c·ªù
const tableEl = document.getElementById('table')

/* ===== INIT PANEL ===== */
function initPanel() {
  createSeats()
  renderSeats()
  loadSeats()
  initRealtime()
  window.addEventListener('resize', renderSeats)
}

/* ===== SEATS ===== */
function createSeats() {
  for (let i = 1; i <= SEAT_COUNT; i++) {

    seatState[i] = { player_uid: null };

    const seat = document.createElement('div');
    seat.className = 'seat';

    const num = document.createElement('div');
    num.textContent = i;

    const uidEl = document.createElement('small');

    seat.appendChild(num);
    seat.appendChild(uidEl);

    // ===== HOLD (scan / eject) =====
    seat.addEventListener('pointerdown', () => {
      didHold = false;
      clearTimeout(holdTimer);

      holdTimer = setTimeout(() => {
        didHold = true;
        if (seatState[i].player_uid) {
          if (confirm(`Reject PLAYER_UID ${seatState[i].player_uid.slice(0,6)} ?`)) {
            ejectUID(i);
          }
        } else {
          scanQRAndAssign(i);
        }
      }, HOLD_TIME);
    });

    seat.addEventListener('pointerup', () => clearTimeout(holdTimer));
    seat.addEventListener('pointerleave', () => clearTimeout(holdTimer));
    seat.addEventListener('pointercancel', () => clearTimeout(holdTimer));

    // ===== TAP (select / unselect seat) =====
    seat.addEventListener('click', () => {
      if (didHold) return;
      if (!seatState[i].player_uid) return;

      // üîÅ click l·∫°i ƒë·ªÉ b·ªè ch·ªçn
      if (selectedSeatNumber === i) {
        selectedSeatNumber = null;
        selectedPlayerId = null;
        selectedSeatLabel = "";

        rakeTotal = 0;
        rakeHistory = [];

        const seatEl = document.getElementById("selectedSeat");
        if (seatEl) seatEl.innerText = "No seat selected";

        renderSeats();
        updateDisplay();
        resetSlider();
        return;
      }

      // üëâ ch·ªçn gh·∫ø
      selectSeat(
        seatState[i].player_uid,
        `Seat ${i} ‚Ä¢ ${seatState[i].player_uid.slice(0,4)}`,
        i
      );
    });

    seats[i] = { el: seat, uidEl };
    tableEl.appendChild(seat);
  }
}



// ch·ªâ g·ªçi click c·ªßa button c≈©
 const thumb = document.getElementById('slideThumb')
const track = thumb.parentElement

let isDragging = false
let startX = 0
let currentX = 0

const maxX = () => track.offsetWidth - thumb.offsetWidth - 4

thumb.addEventListener('pointerdown', e => {
  if (!selectedPlayerId || isSubmitting) return; // ‚¨ÖÔ∏è CH·∫∂N TR∆Ø·ªöC

  isDragging = true;
  startX = e.clientX - thumb.offsetLeft;
  thumb.setPointerCapture(e.pointerId);
});

document.addEventListener('pointermove', e => {
  if (!isDragging) return
  currentX = e.clientX - startX
  currentX = Math.max(4, Math.min(currentX, maxX()))
  thumb.style.left = currentX + 'px'
})

document.addEventListener('pointerup', () => {
  if (!isDragging) return
  isDragging = false

  if (currentX > maxX() * 0.85) {
    thumb.style.left = maxX() + 'px'

document.addEventListener('pointercancel', () => {
  isDragging = false
  thumb.style.left = '4px'
})

    // üî• G·ªåI N√öT C≈®
    document.getElementById('nextHandBtn').click()
  } else {
    thumb.style.left = '4px'
  }
}) 

function resetSlider(){
  currentX = 0
  thumb.style.left = '4px'
}

 



/* ===== RENDER ===== */
function renderSeats() {
  const rect = tableEl.getBoundingClientRect()
  const cx = rect.width / 2
  const cy = rect.height / 2
  const rX = cx - SEAT_SIZE/2 - TABLE_BORDER - SAFE_PADDING + 50
  const rY = cy - SEAT_SIZE/2 - TABLE_BORDER - SAFE_PADDING + 50

  for (let i = 1; i <= SEAT_COUNT; i++) {
    const { el, uidEl } = seats[i]
    const angle = (Math.PI*2/SEAT_COUNT)*(i-TOP_SEAT) - Math.PI/2

    el.style.left = cx + Math.cos(angle)*rX + 'px'
    el.style.top  = cy + Math.sin(angle)*rY + 'px'
    el.style.transform = 'translate(-50%,-50%)'

    el.classList.remove('occupied', 'selected');

if (seatState[i].player_uid) {
  el.classList.add('occupied');
}

if (selectedSeatNumber === i) {
  el.classList.add('selected');
}





    uidEl.textContent = seatState[i].player_uid ? seatState[i].player_uid.slice(0,4) : ''
  }
}

/* ===== DB / REALTIME / QR ===== */
/* (GI·ªÆ NGUY√äN PH·∫¶N C√íN L·∫†I C·ª¶A B·∫†N ‚Äì KH√îNG ƒê·ªòNG G√å) */

/* ===== DB ===== */

async function isValidPlayerUID(player_uid) {
  const { data, error } = await sb
    .from('players')
    .select('player_uid')
    .eq('player_uid', player_uid)
    .single()

  if (error || !data) return false
  return true
}


async function assignUID(seat, player_uid) {
  seatState[seat].player_uid = player_uid
  renderSeats()

  const { data, error } = await sb
    .from('seats')
    .update({ player_uid })
    .eq('table_uid', TABLE_UID)
    .eq('seat_number', seat)
    .select()

  if (error || !data?.length) {
    seatState[seat].player_uid = null
    renderSeats()
    alert('‚ùå G√°n PLAYER_UID th·∫•t b·∫°i')
  }
}

async function ejectUID(seat) {
  const old = seatState[seat].player_uid
  seatState[seat].player_uid = null
  renderSeats()

  const { data, error } = await sb
    .from('seats')
    .update({ player_uid: null })
    .eq('table_uid', TABLE_UID)
    .eq('seat_number', String(seat))
    .select()

  if (error || !data?.length) {
    seatState[seat].player_uid = old
    renderSeats()
    alert('‚ùå Reject th·∫•t b·∫°i')
  }
}

async function loadSeats() {
  const { data } = await sb
    .from('seats')
    .select('*')
    .eq('table_uid', TABLE_UID)

  data?.forEach(r => {
    seatState[String(r.seat_number)].player_uid = r.player_uid
  })
  renderSeats()
}

/* ===== REALTIME ===== */
function initRealtime() {
  sb.channel('seats-' + TABLE_UID)
    .on(
      'postgres_changes',
      {
        event: '*',
        schema: 'public',
        table: 'seats',
        filter: `table_uid=eq.${TABLE_UID}`
      },
      p => {
        seatState[p.new.seat_number].player_uid = p.new.player_uid
        renderSeats()
      }
    )
    .subscribe()
}

/* ===== QR ===== */
let qrScanner = null

async function scanQRAndAssign(seatIndex) {
  const modal = document.getElementById('qrModal')
  const closeBtn = document.getElementById('closeQR')

  modal.style.display = 'flex'
  await safeStopQR()

  setTimeout(async () => {
    qrScanner = new Html5Qrcode('qr-reader')
    qrScanner.start(
      { facingMode: 'environment' },
      { fps: 10, qrbox: 220, aspectRatio: 1 },
      async text => {
        await safeStopQR()
        modal.style.display = 'none'

      const player_uid = text?.trim().replace(/[^a-zA-Z0-9]/g,'').toUpperCase()
if (!player_uid) return alert('QR kh√¥ng h·ª£p l·ªá')

// üîç check UID trong b·∫£ng players
const exists = await isValidPlayerUID(player_uid)
if (!exists) {
  alert('‚ùå UID kh√¥ng t·ªìn t·∫°i trong h·ªá th·ªëng')
  return
}

// ‚úÖ PLAYER_UID h·ª£p l·ªá ‚Üí cho g√°n gh·∫ø
assignUID(seatIndex, player_uid)


      }
    )
  }, 150)

  closeBtn.onclick = async () => {
    await safeStopQR()
    modal.style.display = 'none'
  }
}

async function safeStopQR() {
  if (qrScanner) {
    try {
      if (qrScanner.isScanning) await qrScanner.stop()
      await qrScanner.clear()
    } catch(e){}
    qrScanner = null
  }
}



// g·ªçi fuction n√†y t·ª´ UI seat
function selectSeat(playerId, seatLabel, seatNumber){

  // auto reset khi ƒë·ªïi seat
  rakeTotal = 0;
  rakeHistory = [];

  selectedPlayerId = playerId;
  selectedSeatLabel = seatLabel;
  selectedSeatNumber = seatNumber;

  document.getElementById("selectedSeat").innerText = seatLabel;
  
  renderSeats(); 
  updateDisplay();
}

// Add rake (stack-based undo)

function addRake(amount){

  if(!selectedPlayerId){
    alert("Select a seat first");
    return;
  }

  rakeTotal += amount;
  rakeHistory.push(amount);

  updateDisplay();

  if(navigator.vibrate){
    navigator.vibrate(30);
  }
}


// Undo

function undoRake(){

  if(rakeHistory.length === 0) return;

  const last = rakeHistory.pop();
  rakeTotal -= last;

  updateDisplay();
}

//Update UI

function updateDisplay(){

  const rakeEl = document.getElementById("rakeAmount");
  if (rakeEl) {
    rakeEl.innerText = "$" + rakeTotal;
  }

  const nextBtn = document.getElementById("nextHandBtn");
  if (nextBtn) {
    nextBtn.innerText = `Next Hand ‚Ä¢ $${rakeTotal}`;
  }

  const slideText = document.getElementById("slideText");
  if (slideText) {
    slideText.innerText = `Slide to Next Hand ‚Ä¢ $${rakeTotal}`;
  }

  // ‚úÖ FIX: update slider state ƒë√∫ng l√∫c
  const slideTrack = document.querySelector('.slide-track');
  if (slideTrack) {
    slideTrack.classList.toggle(
      'disabled',
      !selectedPlayerId || isSubmitting
    );
  }
}



//Next Hand

async function nextHand(){

    if(isSubmitting) return;

  if(!selectedPlayerId){
    alert("Select a seat");
    return;
  }

  if(isSubmitting) return;

  if(rakeTotal === 0){
    openModal();
    return;
  }

  await createHand();
}



// Modal control
function openModal(){
  document.getElementById("noRakeModal").style.display = "flex";
}

function closeModal(){
  document.getElementById("noRakeModal").style.display = "none";
}

async function confirmNoRake(){
  closeModal();
  await createHand();
}

//Create hand nh∆∞ng ch∆∞a c√≥ table_uid/dealer_uid (m·ªët th√™m sau)
async function createHand() {
  try {
    isSubmitting = true;

    // 1Ô∏è‚É£ insert rake
    const { data: hand, error: handError } = await sb
      .from("rake_logs")
      .insert({
        table_uid: TABLE_UID,
        player_uid: selectedPlayerId, // "A001"
        rake: rakeTotal
      })
      .select()
      .single();

    if (handError) throw handError;

     

    resetUI();

  } catch (err) {
    console.error(err);
    alert(err.message || "Insert failed");
  } finally {
    isSubmitting = false;
  }
}


//Reset
function resetUI(){

  // reset rake
  rakeTotal = 0;
  rakeHistory = [];

  // reset seat ƒëang ch·ªçn
  selectedPlayerId = null;
  selectedSeatLabel = "";
  selectedSeatNumber = null;

  // reset control panel
  const seatEl = document.getElementById("selectedSeat");
  if (seatEl) {
    seatEl.innerText = "No seat selected";
  }

  // reset UI kh√°c
  updateDisplay();
  resetSlider();
  renderSeats();   // üî• r·∫•t quan tr·ªçng: b·ªè m√†u gh·∫ø ƒëang ch·ªçn
}
// ch·ªëng double insert rake







console.log('dealer2.html V.210')
</script>

</body>
</html>
