<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>Table Counter</title>

<style>
/* ✅ Anti copy/select (trừ input/select/textarea) */
*{
  -webkit-tap-highlight-color: transparent;
  -webkit-user-select: none;
  user-select: none;
  -webkit-touch-callout: none;
}
input, textarea, select{
  -webkit-user-select: text;
  user-select: text;
  -webkit-touch-callout: default;
}

/* ===== THEME (đồng bộ vibe Owner/Agent) ===== */
:root{
  --bg:#070A12;
  --panel:#0B1222;
  --txt:#EAF0FF;

  --purple1:#7C3AED;
  --purple2:#5B21B6;

  --cyan1:#22D3EE;
  --cyan2:#0284C7;

  --green1:#22C55E;
  --green2:#15803D;
}

/* ===== GLOBAL LOCK ===== */
html, body {
  margin: 0;
  padding: 0;
  height: 100%;
  overflow: hidden;
  overscroll-behavior: none;
  touch-action: manipulation;
  background:
    radial-gradient(1200px 600px at 10% -10%, rgba(124,58,237,.30), transparent 55%),
    radial-gradient(900px 600px at 90% 0%, rgba(34,211,238,.18), transparent 55%),
    radial-gradient(900px 600px at 70% 120%, rgba(96,165,250,.12), transparent 60%),
    var(--bg);
  color: var(--txt);
  font-family: system-ui, sans-serif;
}
input, button { font-size: 16px; }

/* ===== COMMON UI: PIN + KEYPAD ===== */
.pin-display{
  display:flex;
  justify-content:space-between;
  gap:12px;
  margin:14px 0;
}
.pin-dot{
  width:16px;height:16px;
  border:2px solid rgba(255,255,255,.18);
  border-radius:50%;
  background: rgba(255,255,255,.03);
}
.pin-dot.filled{
  background: rgba(34,211,238,.95);
  border-color: rgba(34,211,238,.95);
  box-shadow: 0 0 0 6px rgba(34,211,238,.10);
}

.keypad{
  display:grid;
  grid-template-columns: repeat(3, 1fr);
  gap:10px;
}
.keypad button{
  padding:14px;
  font-size:18px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,.10);
  background: rgba(255,255,255,.06);
  color: var(--txt);
  box-shadow: 0 12px 30px rgba(0,0,0,.25);
}
.keypad button:active{
  transform: translateY(1px);
  background: rgba(255,255,255,.09);
}

/* ===== PANEL ===== */
#panelView{ display:block; width:100%; height:100%; }

/* ===== layout ===== */
.app{ display:flex; flex-direction:column; height:100dvh; }
.control-panel{
  flex:3;
  background:
    linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03)),
    rgba(10,15,31,.45);
  color: var(--txt);
  padding:14px 16px 16px;
  border-top:1px solid rgba(255,255,255,.10);
  border-radius:18px 18px 0 0;
  box-shadow:0 -8px 30px rgba(0,0,0,.45);
  backdrop-filter: blur(12px);
}
.table-area{
  flex:7;
  display:flex;
  align-items:center;
  justify-content:center;
}
.table-wrap{
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:22px;
  width:100%;
}

/* ===== TABLE ===== */
.table{
  position:relative;
  width:270px;
  height:190px;
  border-radius:200px;
  background:
    radial-gradient(circle at 35% 30%, rgba(255,255,255,.10), transparent 45%),
    radial-gradient(circle at 70% 75%, rgba(34,211,238,.10), transparent 55%),
    radial-gradient(circle, #0C1222, #070A12 70%);
  border:1px solid rgba(255,255,255,.12);
  box-shadow:
    0 24px 70px rgba(0,0,0,.55),
    inset 0 1px 0 rgba(255,255,255,.10),
    inset 0 -18px 40px rgba(0,0,0,.45);
}

/* ===== CENTER INFO (in table) ===== */
#tableNameLabel{
  
  position:absolute;
  inset:0;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:4px;
  pointer-events:none;
  z-index:10;
  text-align:center;
  padding:0 16px;
}

/* Rivebase mark ở giữa bàn */
#rivebaseMark{
  font-size:18px;
  font-weight:900;
  letter-spacing:.4px;
  line-height:1.1;
  background: linear-gradient(135deg, rgba(124,58,237,.95), rgba(34,211,238,.90));
  -webkit-background-clip: text;
  background-clip: text;
  color: transparent;
  text-shadow: 0 14px 40px rgba(0,0,0,.45);
}

/* Pills cho table/dealer info */
.center-badges{
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:2px;
  width:100%;
}
.center-pill{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  max-width:100%;
  padding:2px 10px;
  border-radius:999px;
  font-size:12px;
  font-weight:800;
  letter-spacing:.2px;
  color: rgba(234,240,255,.85);
  background: rgba(255,255,255,.06);
  border:1px solid rgba(255,255,255,.12);
  box-shadow:
    inset 0 1px 0 rgba(255,255,255,.08),
    0 14px 35px rgba(0,0,0,.35);
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
.center-pill.table{
  background: rgba(124,58,237,.12);
  border-color: rgba(124,58,237,.22);
}
.center-pill.dealer{
  background: rgba(34,211,238,.12);
  border-color: rgba(34,211,238,.22);
}



/* container overlay */
#tableNameLabel{
  position:absolute;
  inset:0;
  pointer-events:none;
  z-index:10;
}



/* Rivebase nằm giữa bàn */
#rivebaseMark{
  position:absolute;
  opacity:.55;
  left:50%;
  top:50%;
  transform:translate(-50%,-50%);
  font-size:18px;
  font-weight:900;
  letter-spacing:.6px;
  line-height:1.1;
  transition:.25s;
  background: linear-gradient(135deg, rgba(124,58,237,.95), rgba(34,211,238,.90));
  -webkit-background-clip: text;
  background-clip: text;
  color: transparent;
  text-shadow: 0 14px 40px rgba(0,0,0,.45);
}

.table.has-selection #rivebaseMark{
  opacity:.18;
  transform:translate(-50%,-50%) scale(.95);
}


/* ===== LOGIN BUTTON ROW ===== */
.login-row{
  display:flex;
  gap:10px;
  width:min(360px, 92%);
  transform: translateY(36px);
}
.login-row .login-btn{
  position:relative;
  border:none;
  cursor:pointer;
  padding:11px 14px;
  border-radius:18px;
  color:#fff;
  font-weight:900;
  letter-spacing:.2px;
  transition: transform .12s ease, filter .12s ease, opacity .12s ease;
  box-shadow:
    0 18px 45px rgba(0,0,0,0.45),
    inset 0 1px 0 rgba(255,255,255,0.18),
    inset 0 -16px 28px rgba(0,0,0,0.25);
  user-select:none;
  width:100%;
  display:flex;
  align-items:center;
  justify-content:center;
}
.login-row .login-btn:active{ transform: translateY(2px); filter: brightness(0.98); }

/* Default states (đổi hệ màu) */
.login-row .login-btn.red{
  background: linear-gradient(180deg, rgba(124,58,237,.95), rgba(91,33,182,.92));
}
#dealerBtn.red{
  background: linear-gradient(180deg, rgba(34,211,238,.95), rgba(2,132,199,.92));
}

.login-row .login-btn.green{
  background: linear-gradient(180deg, rgba(34,197,94,.92), rgba(21,128,61,.90));
}

.login-row .login-btn.gray{
  background: linear-gradient(180deg, rgba(148,163,184,0.22), rgba(148,163,184,0.10));
  color: rgba(234,240,255,.75);
}

.login-row .login-btn .progressBar{
  position:absolute; left:10px; right:10px; bottom:8px;
  height:6px; border-radius:999px;
  background: rgba(255,255,255,0.16);
  overflow:hidden;
  opacity:0;
  pointer-events:none;
}
.login-row .login-btn.holding .progressBar{ opacity:1; }
.login-row .login-btn .progressFill{
  height:100%; width:0%;
  border-radius:999px;
  background: rgba(255,255,255,0.92);
}

/* ratio: Table nhỏ hơn, Dealer dài hơn */
#tableBtn{ flex:2; }
#dealerBtn{ flex:3; }

/* Seats */
.seat{
  position:absolute;
  width:60px; height:60px;
  border-radius:50%;
  background: rgba(255,255,255,.05);
  border:1px solid rgba(255,255,255,.12);
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  font-weight:800;
  cursor:pointer;
  touch-action:none;
  box-shadow:
    0 14px 35px rgba(0,0,0,.35),
    inset 0 1px 0 rgba(255,255,255,.08);
}
.seat.occupied{
  background: linear-gradient(180deg, rgba(34,211,238,.92), rgba(2,132,199,.88));
  border-color: rgba(34,211,238,.55);
  box-shadow: 0 18px 45px rgba(34,211,238,.14);
}
.seat small{ font-size:10px; opacity:.9; color: rgba(234,240,255,.85); }
.seat.selected{
  background: linear-gradient(180deg, rgba(245,158,11,.95), rgba(217,119,6,.92));
  border-color: rgba(245,158,11,.65);
  color:#0A0F1F;
  box-shadow:0 0 0 3px rgba(245,158,11,.30), 0 22px 55px rgba(0,0,0,.35);
}

/* ===== SLIDER (3D hơn) ===== */
.slide-container { width:100%; max-width:360px; margin:16px auto 6px; }
.slide-track{
  position:relative;
  height:56px;
  border-radius:999px;
  overflow:hidden;

  background:
    radial-gradient(120px 60px at 20% 30%, rgba(124,58,237,.18), transparent 65%),
    radial-gradient(120px 60px at 80% 70%, rgba(34,211,238,.14), transparent 65%),
    linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.04));

  border:1px solid rgba(255,255,255,.12);
  box-shadow:
    inset 0 1px 0 rgba(255,255,255,.12),
    inset 0 -18px 30px rgba(0,0,0,.35),
    0 18px 45px rgba(0,0,0,.45);
}
.slide-track:after{
  content:"";
  position:absolute; inset:0;
  background: linear-gradient(90deg, rgba(255,255,255,.10), transparent 35%, rgba(255,255,255,.06));
  opacity:.35;
  pointer-events:none;
}

.slide-text{
  position:absolute; width:100%; height:100%;
  color: rgba(234,240,255,.65);
  font-size:15px;
  font-weight:900;
  display:flex; align-items:center; justify-content:center;
  pointer-events:none;
  text-shadow: 0 10px 25px rgba(0,0,0,.45);
}

.slide-thumb{
  position:absolute; top:4px; left:4px;
  width:48px; height:48px;
  border-radius:50%;
  cursor:pointer;
  touch-action:none;

  background:
    radial-gradient(14px 14px at 30% 30%, rgba(255,255,255,.95), rgba(255,255,255,.55) 45%, rgba(255,255,255,.20) 70%),
    linear-gradient(180deg, rgba(255,255,255,.95), rgba(255,255,255,.72));

  border:1px solid rgba(255,255,255,.26);

  box-shadow:
    0 18px 40px rgba(0,0,0,.45),
    inset 0 1px 0 rgba(255,255,255,.85),
    inset 0 -14px 22px rgba(0,0,0,.12);
}
.slide-thumb:after{
  content:"";
  position:absolute;
  inset:10px;
  border-radius:50%;
  background: linear-gradient(135deg, rgba(124,58,237,.25), rgba(34,211,238,.18));
  opacity:.8;
  pointer-events:none;
}
.slide-track.disabled{ opacity:.42; filter: saturate(.9); }

/* ===== Rake buttons (đồng bộ panel) ===== */
.rake-btn{
  border:none;
  padding:10px 14px;
  border-radius:14px;
  margin:6px 6px 0;
  color:#0A0F1F;
  font-weight:900;
  cursor:pointer;
  background:#fff;
  box-shadow: 0 18px 45px rgba(0,0,0,.35);
}
.rake-btn:active{ transform: translateY(1px); }
.rake-btn:nth-of-type(1){
  background: linear-gradient(180deg, rgba(34,211,238,.95), rgba(2,132,199,.92));
  color:#001018;
}
.rake-btn:nth-of-type(2){
  background: linear-gradient(180deg, rgba(124,58,237,.95), rgba(91,33,182,.92));
  color:#fff;
}
.rake-btn:nth-of-type(3){
  background: linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.78));
  color:#0A0F1F;
  border:1px solid rgba(255,255,255,.25);
}

/* Next Hand button (fallback) */
#nextHandBtn{
  border:none;
  padding:12px 14px;
  border-radius:14px;
  background: linear-gradient(180deg, rgba(34,197,94,.92), rgba(21,128,61,.90));
  color:#03110A;
  font-weight:900;
  box-shadow: 0 18px 45px rgba(0,0,0,.35);
}

/* ===== MODAL ===== */
.modal{
  position:fixed; inset:0;
  background: rgba(0,0,0,.60);
  display:none;
  align-items:flex-start;
  justify-content:center;
  z-index:9998;
  padding:16px;
  padding-top:16vh;
}
.modal .box{
  width:min(320px, 92%);
  background:
    linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.04));
  padding:16px;
  border-radius:16px;
  text-align:center;
  border:1px solid rgba(255,255,255,0.12);
  box-shadow:0 25px 70px rgba(0,0,0,0.55);
  backdrop-filter: blur(18px);
}
.modal .top{
  display:flex;
  align-items:center;
  justify-content:space-between;
  margin-bottom:10px;
}
.modal .title{
  font-size:16px;
  font-weight:900;
  color:rgba(234,240,255,.90);
}
.modal .close{
  border:none;
  background:transparent;
  color:#94a3b8;
  font-size:18px;
  padding:6px 10px;
  border-radius:10px;
  cursor:pointer;
}
.modal .close:active{ background: rgba(255,255,255,0.06); }
.modal select{
  width:100%;
  padding:16px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,.12);
  font-size:16px;
  background: rgba(0,0,0,.35);
  color: var(--txt);
  outline:none;
}
.modal .err{
  display:none;
  margin-top:10px;
  text-align:center;
  font-size:12px;
  color:#fca5a5;
  font-weight:900;
}

/* ===== QR MODAL ===== */
#qrModal{
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.85);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}

@keyframes tableGlow {
  0%, 100% { box-shadow: 0 24px 70px rgba(0,0,0,.55), inset 0 1px 0 rgba(255,255,255,.10), inset 0 -18px 40px rgba(0,0,0,.45); }
  50%      { box-shadow: 0 28px 78px rgba(0,0,0,.60), 0 0 0 1px rgba(124,58,237,.10), 0 0 40px rgba(34,211,238,.08), inset 0 1px 0 rgba(255,255,255,.10), inset 0 -18px 40px rgba(0,0,0,.45); }
}
.table{
  animation: tableGlow 5.8s ease-in-out infinite;
}



</style>
</head>

<body>

<!-- ===== PANEL VIEW ===== -->
<div id="panelView">
  <div class="app">
    <div class="table-area">
      <div class="table-wrap">
        <div class="table" id="table">
        <div id="tableNameLabel">
 

  <!-- Giữa bàn -->
  <div id="rivebaseMark">Rivebase</div>
</div>

        </div>

        <!-- 2 buttons row -->
        <div class="login-row">
          <button id="tableBtn" class="login-btn red" type="button">
            <span id="tableBtnText">Table Login</span>
            <span class="progressBar"><span id="tableProgress" class="progressFill"></span></span>
          </button>

          <button id="dealerBtn" class="login-btn red" type="button">
            <span id="dealerBtnText">Dealer Login</span>
            <span class="progressBar"><span id="dealerProgress" class="progressFill"></span></span>
          </button>
        </div>
      </div>
    </div>

    <div class="control-panel">
      <div id="rakePanel" style="text-align:center; margin-top:14px;">
        <div id="selectedSeat" style="font-size:22px; font-weight:800; color: rgba(234,240,255,.92);">No seat selected</div>
        <div id="rakeAmount" style="font-size:72px; font-weight:900; margin:18px 0; letter-spacing:.2px;">$0</div>

        <button class="rake-btn" onclick="addRake(1)">+$1</button>
        <button class="rake-btn" onclick="addRake(5)">+$5</button>
        <button class="rake-btn" onclick="undoRake()">← Back</button>

        <br><br>

        <button id="nextHandBtn" onclick="nextHand()" style="display:none">Next Hand</button>

        <div class="slide-container">
          <div class="slide-track">
            <span class="slide-text" id="slideText">Slide to Next Hand</span>
            <div class="slide-thumb" id="slideThumb"></div>
          </div>
        </div>
      </div>

      <div id="noRakeModal" style="
        display:none;
        position:fixed;
        top:0;left:0;right:0;bottom:0;
        background:rgba(0,0,0,0.6);
        align-items:center;
        justify-content:center;">

        <div style="background:white; padding:40px; border-radius:16px; text-align:center;">
          <h2>NO RAKE</h2>
          <p>Close this hand with $0?</p>

          <button onclick="confirmNoRake()" style="font-size:20px; padding:12px 24px;">Next Hand</button>
          <button onclick="closeModal()" style="font-size:20px; padding:12px 24px;">Back</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- TABLE MODAL -->
<div id="tableModal" class="modal">
  <div class="box">
    <div class="top">
      <div class="title">Table Login</div>
      <button id="tableClose" class="close" type="button">✕</button>
    </div>

    <select id="tableSelect">
      <option value="">Loading…</option>
    </select>

    <div class="pin-display" id="tablePinDots" style="margin-top:12px">
      <div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div>
    </div>

    <div class="keypad">
      <button onclick="tablePress(1)">1</button>
      <button onclick="tablePress(2)">2</button>
      <button onclick="tablePress(3)">3</button>
      <button onclick="tablePress(4)">4</button>
      <button onclick="tablePress(5)">5</button>
      <button onclick="tablePress(6)">6</button>
      <button onclick="tablePress(7)">7</button>
      <button onclick="tablePress(8)">8</button>
      <button onclick="tablePress(9)">9</button>
      <button onclick="tableBack()">←</button>
      <button onclick="tablePress(0)">0</button>
      <button onclick="submitTableLogin()">OK</button>
    </div>

    <div id="tableErr" class="err">❌ Wrong PIN</div>
  </div>
</div>

<!-- DEALER MODAL -->
<div id="dealerModal" class="modal">
  <div class="box">
    <div class="top">
      <div class="title">Dealer Login</div>
      <button id="dealerClose" class="close" type="button">✕</button>
    </div>

    <select id="dealerSelect">
      <option value="">Loading…</option>
    </select>

    <div class="pin-display" id="dealerPinDots" style="margin-top:12px">
      <div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div>
    </div>

    <div class="keypad">
      <button onclick="dealerPress(1)">1</button>
      <button onclick="dealerPress(2)">2</button>
      <button onclick="dealerPress(3)">3</button>
      <button onclick="dealerPress(4)">4</button>
      <button onclick="dealerPress(5)">5</button>
      <button onclick="dealerPress(6)">6</button>
      <button onclick="dealerPress(7)">7</button>
      <button onclick="dealerPress(8)">8</button>
      <button onclick="dealerPress(9)">9</button>
      <button onclick="dealerBack()">←</button>
      <button onclick="dealerPress(0)">0</button>
      <button onclick="submitDealerLogin()">OK</button>
    </div>

    <div id="dealerErr" class="err">❌ Wrong PIN</div>
  </div>
</div>

<!-- QR MODAL -->
<div id="qrModal">
  <div style="width:260px;background:#000;padding:12px;border-radius:12px">
    <div id="qr-reader" style="width:100%; min-height:240px"></div>
    <button id="closeQR" style="
      width:100%;
      margin-top:10px;
      padding:10px;
      border:none;
      border-radius:8px;
      background:#374151;
      color:#fff;
      font-size:16px;
    ">Cancel</button>
  </div>
</div>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="https://unpkg.com/html5-qrcode"></script>

<script>
/* ✅ extra anti copy (mobile) */
document.addEventListener('contextmenu', e => e.preventDefault());
document.addEventListener('dragstart', e => e.preventDefault());

/* ===== LOCK ZOOM ===== */
document.addEventListener('gesturestart', e => e.preventDefault());
document.addEventListener('gesturechange', e => e.preventDefault());
document.addEventListener('gestureend', e => e.preventDefault());

/* ===== CONFIG ===== */
const HOLD_TIME = 700;
const SEAT_COUNT = 9;
const TOP_SEAT = 5;
const SEAT_SIZE = 60;
const TABLE_BORDER = 4;
const SAFE_PADDING = 8;

/* ===== STATE ===== */
let rakeTotal = 0;
let rakeHistory = [];
let selectedPlayerId = null;
let selectedSeatNumber = null;
let isSubmitting = false;

let TABLE_UID = null;
let TABLE_NAME = null;

let tablePin = "";

let DEALER_UID = null;
let DEALER_NAME = null;
let dealerPin = "";

const seatState = {};
const seats = {};
let holdTimer = null;
let didHold = false;

let qrScanner = null;
let seatChannel = null;

/* ===== SUPABASE (ANON KEY) ===== */
const SUPABASE_URL = 'https://ymtmipkmknnsqleahlmi.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InltdG1pcGtta25uc3FsZWFobG1pIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAwOTU1MjUsImV4cCI6MjA4NTY3MTUyNX0.7pEza-TKBKJ_xqdBu93nLo-PRaHDcDIxW-bjZnrFJxw';
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ===== DOM ===== */
const tableEl = document.getElementById('table');

const tableBtn = document.getElementById('tableBtn');
const tableBtnText = document.getElementById('tableBtnText');
const tableProgress = document.getElementById('tableProgress');

const dealerBtn = document.getElementById('dealerBtn');
const dealerBtnText = document.getElementById('dealerBtnText');
const dealerProgress = document.getElementById('dealerProgress');

const tableModal = document.getElementById('tableModal');
const tableClose = document.getElementById('tableClose');
const tableSelect = document.getElementById('tableSelect');
const tableErrEl = document.getElementById('tableErr');

const dealerModal = document.getElementById('dealerModal');
const dealerClose = document.getElementById('dealerClose');
const dealerSelect = document.getElementById('dealerSelect');
const dealerErrEl = document.getElementById('dealerErr');

const thumb = document.getElementById('slideThumb');
const track = thumb.parentElement;

/* ===== Helpers ===== */
function isTableLoggedIn(){ return !!TABLE_UID; }
function isDealerLoggedIn(){ return !!DEALER_UID; }

function setDots(containerId, len){
  const wrap = document.getElementById(containerId);
  if (!wrap) return;
  wrap.querySelectorAll('.pin-dot').forEach((d,i)=> d.classList.toggle('filled', i < len));
}

function updateTableCenterInfo(){
  const t = document.getElementById("tableInfoText");
  const d = document.getElementById("dealerInfoText");
  if (!t || !d) return;

    // hiển thị theo kiểu ngắn gọn ở góc trái
  t.textContent = `Table: ${TABLE_NAME || TABLE_UID || "—"}`;
  d.textContent = `Dealer: ${DEALER_NAME || DEALER_UID || "—"}`;

  // pills text (ngắn gọn + dễ đọc)
  t.textContent = `TABLE • ${TABLE_UID || "—"}`;
  d.textContent = `DEALER • ${DEALER_UID || "—"}`;
}

function setTableUI(){
  if (isTableLoggedIn()){
    tableBtn.classList.remove('red','gray');
    tableBtn.classList.add('green');
    tableBtnText.textContent = (TABLE_NAME || TABLE_UID || "Table");
  }else{
    tableBtn.classList.remove('green','gray');
    tableBtn.classList.add('red');
    tableBtnText.textContent = "Table Login";
  }
  updateTableCenterInfo();
}

function setDealerUI(){
  if (!isTableLoggedIn()){
    dealerBtn.classList.remove('green','red');
    dealerBtn.classList.add('gray');
    dealerBtnText.textContent = "Table Login";
    updateTableCenterInfo();
    return;
  }

  if (isDealerLoggedIn()){
    dealerBtn.classList.remove('red','gray');
    dealerBtn.classList.add('green');
    dealerBtnText.textContent = (DEALER_NAME || DEALER_UID || "Dealer");
  }else{
    dealerBtn.classList.remove('green','gray');
    dealerBtn.classList.add('red');
    dealerBtnText.textContent = "Dealer Login";
  }
  updateTableCenterInfo();
}

function requireTable(){
  if (isTableLoggedIn()) return true;
  alert("Table login required");
  openTableModal();
  return false;
}
function requireDealer(){
  if (!requireTable()) return false;
  if (isDealerLoggedIn()) return true;
  alert("Dealer login required");
  openDealerModal();
  return false;
}

/* ===== Display ===== */
function updateDisplay(){
  const rakeEl = document.getElementById("rakeAmount");
  if (rakeEl) rakeEl.innerText = "$" + (rakeTotal || 0);

  const nextBtn = document.getElementById("nextHandBtn");
  if (nextBtn) nextBtn.innerText = `Next Hand • $${rakeTotal || 0}`;

  const slideText = document.getElementById("slideText");
  if (slideText) slideText.innerText = `Slide to Next Hand • $${rakeTotal || 0}`;

  const slideTrack = document.querySelector('.slide-track');
  if (slideTrack){
    slideTrack.classList.toggle('disabled', !isDealerLoggedIn() || !selectedPlayerId || isSubmitting);
  }
}


/* kêu tiếng */
let audioCtx = null;

function playSuccessTone(){
  if(!audioCtx){
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }

  const now = audioCtx.currentTime;

  const osc1 = audioCtx.createOscillator();
  const osc2 = audioCtx.createOscillator();
  const gain = audioCtx.createGain();

  osc1.type = "sine";
  osc2.type = "sine";

  osc1.frequency.value = 880;
  osc2.frequency.value = 1320; // perfect fifth

  gain.gain.value = 0.035;

  osc1.connect(gain);
  osc2.connect(gain);
  gain.connect(audioCtx.destination);

  osc1.start(now);
  osc2.start(now);

  gain.gain.exponentialRampToValueAtTime(0.0001, now + 0.09);

  osc1.stop(now + 0.09);
  osc2.stop(now + 0.09);
}




/* ===== TABLE MODAL ===== */
function openTableModal(){
  tableModal.style.display = "flex";
  resetTableModalUI();
  loadTablesForModal();
}
function closeTableModal(){
  tableModal.style.display = "none";
  resetTableModalUI();
}
function resetTableModalUI(){
  tableSelect.value = "";
  tableSelect.innerHTML = `<option value="">Loading…</option>`;
  tablePin = "";
  setDots('tablePinDots', 0);
  tableErrEl.style.display = "none";
}
tableClose.addEventListener('click', closeTableModal);
tableModal.addEventListener('click', (e) => { if (e.target === tableModal) closeTableModal(); });

function tablePress(n){
  if (!tableSelect.value){
    tableErrEl.style.display="block";
    tableErrEl.textContent="❌ Select table first";
    return;
  }
  tableErrEl.style.display = "none";
  if (tablePin.length >= 4) return;
  tablePin += String(n);
  setDots('tablePinDots', tablePin.length);
  if (tablePin.length === 4) submitTableLogin();
}
function tableBack(){
  tableErrEl.style.display = "none";
  tablePin = tablePin.slice(0,-1);
  setDots('tablePinDots', tablePin.length);
}

async function loadTablesForModal(){
  try{
    const { data, error } = await sb
      .from('tables')
      .select('table_uid, table_name')
      .eq('active', true)
      .order('table_uid');

    if (error){
      console.error("loadTables error:", error);
      tableSelect.innerHTML = `<option value="">Load failed</option>`;
      return;
    }

    const rows = data || [];
    tableSelect.innerHTML =
      `<option value="">— Select table —</option>` +
      rows.map(t => {
        const name = String((t.table_name||"")).trim();
        const label = name ? name : String(t.table_uid);
        return `<option value="${String(t.table_uid)}">${label}</option>`;
      }).join("");

    if (!rows.length){
      tableSelect.innerHTML = `<option value="">No active tables</option>`;
    }
  }catch(e){
    console.error("loadTables exception:", e);
    tableSelect.innerHTML = `<option value="">Load failed</option>`;
  }
}

async function submitTableLogin(){
  const table = tableSelect.value;
  if (!table) return;
  if (tablePin.length !== 4) return;

  const { data, error } = await sb
    .from('tables')
    .select('table_uid, table_name, pin_hash, active')
    .eq('table_uid', table)
    .single();

  if (error || !data){
    tableErrEl.textContent = "❌ Table not found";
    tableErrEl.style.display = "block";
    tablePin = ""; setDots('tablePinDots', 0);
    return;
  }
  if (!data.active){
    tableErrEl.textContent = "❌ Table locked";
    tableErrEl.style.display = "block";
    tablePin = ""; setDots('tablePinDots', 0);
    return;
  }
  if (String(data.pin_hash) !== tablePin){
    tableErrEl.textContent = "❌ Wrong PIN";
    tableErrEl.style.display = "block";
    tablePin = ""; setDots('tablePinDots', 0);
    return;
  }

  // đổi bàn => logout dealer để tránh nhầm
  if (TABLE_UID && TABLE_UID !== data.table_uid){
    dealerLogout();
  }

  TABLE_UID = data.table_uid;
  TABLE_NAME = (data.table_name || "").trim() || data.table_uid;

  localStorage.setItem("table_uid", TABLE_UID);
  localStorage.setItem("table_name", TABLE_NAME);

  setTableUI();
  setDealerUI();
  await startTableSession();
  closeTableModal();
}

/* ===== DEALER MODAL ===== */
function openDealerModal(){
  if (!requireTable()) return;
  dealerModal.style.display = "flex";
  resetDealerModalUI();
  loadDealersForModal();
}
function closeDealerModal(){
  dealerModal.style.display = "none";
  resetDealerModalUI();
}
function resetDealerModalUI(){
  dealerSelect.value = "";
  dealerSelect.innerHTML = `<option value="">Loading…</option>`;
  dealerPin = "";
  setDots('dealerPinDots', 0);
  dealerErrEl.style.display = "none";
}
dealerClose.addEventListener('click', closeDealerModal);
dealerModal.addEventListener('click', (e) => { if (e.target === dealerModal) closeDealerModal(); });

async function loadDealersForModal(){
  const { data, error } = await sb.rpc('list_dealers');
  if (error){
    console.error(error);
    dealerSelect.innerHTML = `<option value="">Load failed</option>`;
    return;
  }
  const rows = data || [];
  if (!rows.length){
    dealerSelect.innerHTML = `<option value="">No dealers</option>`;
    return;
  }
  dealerSelect.innerHTML =
    `<option value="">— Select your name —</option>` +
    rows.map(d => `<option value="${String(d.dealer_uid)}">${String(d.dealer_name||"")}</option>`).join("");
}

function dealerPress(n){
  if (!requireTable()) return;

  if (!dealerSelect.value) {
    dealerErrEl.style.display="block";
    dealerErrEl.textContent="❌ Select dealer first";
    return;
  }
  dealerErrEl.style.display = "none";

  if (dealerPin.length >= 4) return;
  dealerPin += String(n);
  setDots('dealerPinDots', dealerPin.length);

  if (dealerPin.length === 4) submitDealerLogin();
}
function dealerBack(){
  dealerErrEl.style.display = "none";
  dealerPin = dealerPin.slice(0,-1);
  setDots('dealerPinDots', dealerPin.length);
}

async function submitDealerLogin(){
  if (!requireTable()) return;
  if (!dealerSelect.value) return;
  if (dealerPin.length !== 4) return;

  const { data, error } = await sb.rpc('verify_dealer_pin', {
    p_dealer_uid: dealerSelect.value,
    p_pin: dealerPin
  });

  if (error){
    console.error(error);
    dealerErrEl.textContent = "❌ Verify failed";
    dealerErrEl.style.display = "block";
    dealerPin = "";
    setDots('dealerPinDots', 0);
    return;
  }

  const row = Array.isArray(data) ? data[0] : data;
  if (row?.ok){
    DEALER_UID = row.dealer_uid;
    DEALER_NAME = row.dealer_name;

    localStorage.setItem("dealer_uid", DEALER_UID);
    localStorage.setItem("dealer_name", DEALER_NAME);

    setDealerUI();
    closeDealerModal();
  }else{
    dealerErrEl.textContent = "❌ Wrong PIN";
    dealerErrEl.style.display = "block";
    dealerPin = "";
    setDots('dealerPinDots', 0);
  }
}

/* ===== Logout ===== */
function dealerLogout(){
  DEALER_UID = null;
  DEALER_NAME = null;
  localStorage.removeItem("dealer_uid");
  localStorage.removeItem("dealer_name");
  setDealerUI();
  resetUI();
}

async function tableLogout(){
  if (seatChannel){
    try{ await seatChannel.unsubscribe(); }catch(e){}
    seatChannel = null;
  }

  TABLE_UID = null;
  TABLE_NAME = null;
  localStorage.removeItem("table_uid");
  localStorage.removeItem("table_name");

  dealerLogout();

  for (let i=1;i<=SEAT_COUNT;i++){
    seatState[i] = { player_uid: null };
  }
  renderSeats();

  setTableUI();
  setDealerUI();

  setTimeout(openTableModal, 120);
}

/* ===== Hold logout (Table + Dealer) ===== */
let tableHoldTimer = null;
let tableHoldStart = 0;

function startTableHold(){
  if (tableHoldTimer) return;
  tableHoldStart = performance.now();
  tableBtn.classList.add("holding");
  tableProgress.style.width = "0%";

  tableHoldTimer = setInterval(() => {
    const t = performance.now() - tableHoldStart;
    const pct = Math.min(100, (t / HOLD_TIME) * 100);
    tableProgress.style.width = pct.toFixed(0) + "%";
    if (t >= HOLD_TIME) stopTableHold(true);
  }, 16);
}
function stopTableHold(trigger=false){
  if (tableHoldTimer){
    clearInterval(tableHoldTimer);
    tableHoldTimer = null;
  }
  tableBtn.classList.remove("holding");
  tableProgress.style.width = "0%";

  if (trigger && isTableLoggedIn()){
    if (confirm(`Logout table ${TABLE_UID}?`)) tableLogout();
  }
}

let dealerHoldTimer = null;
let dealerHoldStart = 0;

function startDealerHold(){
  if (dealerHoldTimer) return;
  dealerHoldStart = performance.now();
  dealerBtn.classList.add("holding");
  dealerProgress.style.width = "0%";

  dealerHoldTimer = setInterval(() => {
    const t = performance.now() - dealerHoldStart;
    const pct = Math.min(100, (t / HOLD_TIME) * 100);
    dealerProgress.style.width = pct.toFixed(0) + "%";
    if (t >= HOLD_TIME) stopDealerHold(true);
  }, 16);
}
function stopDealerHold(trigger=false){
  if (dealerHoldTimer){
    clearInterval(dealerHoldTimer);
    dealerHoldTimer = null;
  }
  dealerBtn.classList.remove("holding");
  dealerProgress.style.width = "0%";

  if (trigger && isDealerLoggedIn()){
    if (confirm(`Logout dealer ${DEALER_NAME}?`)) dealerLogout();
  }
}

/* bind table btn: ✅ tap KHÔNG cho đổi bàn */
tableBtn.addEventListener("pointerdown", (e) => {
  if (e.button !== undefined && e.button !== 0) return;
  startTableHold();
});
tableBtn.addEventListener("pointerup", () => stopTableHold(false));
tableBtn.addEventListener("pointerleave", () => stopTableHold(false));
tableBtn.addEventListener("pointercancel", () => stopTableHold(false));
tableBtn.addEventListener("click", () => {
  if (!isTableLoggedIn()) openTableModal();
});

/* bind dealer btn */
dealerBtn.addEventListener("pointerdown", (e) => {
  if (e.button !== undefined && e.button !== 0) return;
  startDealerHold();
});
dealerBtn.addEventListener("pointerup", () => stopDealerHold(false));
dealerBtn.addEventListener("pointerleave", () => stopDealerHold(false));
dealerBtn.addEventListener("pointercancel", () => stopDealerHold(false));
dealerBtn.addEventListener("click", () => {
  if (!isTableLoggedIn()) return openTableModal();
  if (!isDealerLoggedIn()) openDealerModal();
});

/* ===== PANEL / SEATS ===== */
let panelInited = false;

function initPanelOnce(){
  if (panelInited) return;
  panelInited = true;
  createSeats();
  renderSeats();
  window.addEventListener('resize', renderSeats);
}

async function startTableSession(){
  initPanelOnce();
  await loadSeats();
  await initRealtime();
  renderSeats();
}

function createSeats(){
  for (let i = 1; i <= SEAT_COUNT; i++){
    if (seats[i]?.el) continue;

    seatState[i] = { player_uid: null };

    const seat = document.createElement('div');
    seat.className = 'seat';

    const num = document.createElement('div');
    num.textContent = i;

    const uidEl = document.createElement('small');

    seat.appendChild(num);
    seat.appendChild(uidEl);

    seat.addEventListener('pointerdown', () => {
      if (!requireDealer()) return;

      didHold = false;
      clearTimeout(holdTimer);

      holdTimer = setTimeout(() => {
        didHold = true;
        if (seatState[i].player_uid) {
          if (confirm(`Reject PLAYER_UID ${seatState[i].player_uid.slice(0,6)} ?`)) ejectUID(i);
        } else {
          scanQRAndAssign(i);
        }
      }, HOLD_TIME);
    });

    seat.addEventListener('pointerup', () => clearTimeout(holdTimer));
    seat.addEventListener('pointerleave', () => clearTimeout(holdTimer));
    seat.addEventListener('pointercancel', () => clearTimeout(holdTimer));

    seat.addEventListener('click', () => {
      if (didHold) return;
      if (!requireDealer()) return;
      if (!seatState[i].player_uid) return;

      if (selectedSeatNumber === i){
        resetUI();
        return;
      }

      selectSeat(seatState[i].player_uid, i);
    });

    seats[i] = { el: seat, uidEl };
    tableEl.appendChild(seat);
  }
}

function renderSeats(){
  const rect = tableEl.getBoundingClientRect();
  const cx = rect.width / 2;
  const cy = rect.height / 2;
  const rX = cx - SEAT_SIZE/2 - TABLE_BORDER - SAFE_PADDING + 50;
  const rY = cy - SEAT_SIZE/2 - TABLE_BORDER - SAFE_PADDING + 50;

  for (let i=1; i<=SEAT_COUNT; i++){
    const s = seats[i];
    if (!s?.el) continue;

    const angle = (Math.PI*2/SEAT_COUNT)*(i-TOP_SEAT) - Math.PI/2;

    s.el.style.left = cx + Math.cos(angle)*rX + 'px';
    s.el.style.top  = cy + Math.sin(angle)*rY + 'px';
    s.el.style.transform = 'translate(-50%,-50%)';

    s.el.classList.remove('occupied','selected');
    if (seatState[i].player_uid) s.el.classList.add('occupied');
    if (selectedSeatNumber === i) s.el.classList.add('selected');

    s.uidEl.textContent = seatState[i].player_uid ? seatState[i].player_uid.slice(0,4) : '';
  }
}

/* ===== slider ===== */
let isDragging = false, startX = 0, currentX = 0;
const maxX = () => track.offsetWidth - thumb.offsetWidth - 4;

thumb.addEventListener('pointerdown', e => {
  if (!requireDealer()) return;
  if (!selectedPlayerId || isSubmitting) return;

  isDragging = true;
  startX = e.clientX - thumb.offsetLeft;
  thumb.setPointerCapture(e.pointerId);
});

document.addEventListener('pointermove', e => {
  if (!isDragging) return;
  currentX = e.clientX - startX;
  currentX = Math.max(4, Math.min(currentX, maxX()));
  thumb.style.left = currentX + 'px';
});

document.addEventListener('pointerup', () => {
  if (!isDragging) return;
  isDragging = false;

 if (currentX > maxX() * 0.85) {

    playSuccessTone();   // ⭐ thêm dòng này

    thumb.style.left = maxX() + 'px';
    document.getElementById('nextHandBtn').click();


  } else {
    thumb.style.left = '4px';
  }
});

document.addEventListener('pointercancel', () => {
  isDragging = false;
  thumb.style.left = '4px';
});

function resetSlider(){
  currentX = 0;
  thumb.style.left = '4px';
}

/* ===== DB / Realtime / QR ===== */
async function loadSeats(){
  if (!TABLE_UID) return;
  const { data } = await sb.from('seats').select('*').eq('table_uid', TABLE_UID);
  (data||[]).forEach(r => { seatState[String(r.seat_number)].player_uid = r.player_uid; });
  renderSeats();
}

async function initRealtime(){
  if (!TABLE_UID) return;

  if (seatChannel){
    try{ await seatChannel.unsubscribe(); }catch(e){}
    seatChannel = null;
  }

  seatChannel = sb.channel('seats-' + TABLE_UID)
    .on('postgres_changes',
      { event:'*', schema:'public', table:'seats', filter:`table_uid=eq.${TABLE_UID}` },
      p => {
        seatState[p.new.seat_number].player_uid = p.new.player_uid;
        renderSeats();
      }
    )
    .subscribe();
}

async function isValidPlayerUID(player_uid){
  const { data, error } = await sb.from('players').select('player_uid').eq('player_uid', player_uid).single();
  return !(error || !data);
}

async function assignUID(seat, player_uid){
  seatState[seat].player_uid = player_uid;
  renderSeats();

  const { data, error } = await sb
    .from('seats')
    .update({ player_uid })
    .eq('table_uid', TABLE_UID)
    .eq('seat_number', seat)
    .select();

  if (error || !data?.length){
    seatState[seat].player_uid = null;
    renderSeats();
    alert('❌ Gán PLAYER_UID thất bại');
  }
}

async function ejectUID(seat){
  const old = seatState[seat].player_uid;
  seatState[seat].player_uid = null;
  renderSeats();

  const { data, error } = await sb
    .from('seats')
    .update({ player_uid: null })
    .eq('table_uid', TABLE_UID)
    .eq('seat_number', String(seat))
    .select();

  if (error || !data?.length){
    seatState[seat].player_uid = old;
    renderSeats();
    alert('❌ Reject thất bại');
  }
}

async function scanQRAndAssign(seatIndex){
  const modal = document.getElementById('qrModal');
  const closeBtn = document.getElementById('closeQR');

  modal.style.display = 'flex';
  await safeStopQR();

  setTimeout(async () => {
    qrScanner = new Html5Qrcode('qr-reader');
    qrScanner.start(
      { facingMode:'environment' },
      { fps:10, qrbox:220, aspectRatio:1 },
      async text => {
        await safeStopQR();
        modal.style.display = 'none';

        const player_uid = text?.trim().replace(/[^a-zA-Z0-9]/g,'').toUpperCase();
        if (!player_uid) return alert('QR không hợp lệ');

        const exists = await isValidPlayerUID(player_uid);
        if (!exists) return alert('❌ UID không tồn tại trong hệ thống');

        assignUID(seatIndex, player_uid);
      }
    );
  }, 150);

  closeBtn.onclick = async () => {
    await safeStopQR();
    modal.style.display = 'none';
  };
}

async function safeStopQR(){
  if (qrScanner){
    try{
      if (qrScanner.isScanning) await qrScanner.stop();
      await qrScanner.clear();
    }catch(e){}
    qrScanner = null;
  }
}

/* ===== Rake flow ===== */
function selectSeat(playerId, seatNumber){
  rakeTotal = 0;
  rakeHistory = [];
  selectedPlayerId = playerId;
  selectedSeatNumber = seatNumber;

  document.getElementById("selectedSeat").innerText = `Seat ${seatNumber} • ${playerId.slice(0,4)}`;
  renderSeats();
  updateDisplay();
}

function addRake(amount){
  if (!requireDealer()) return;
  if (!selectedPlayerId) return alert("Select a seat first");
  rakeTotal += amount;
  rakeHistory.push(amount);
  updateDisplay();
  if (navigator.vibrate) navigator.vibrate(30);
}

function undoRake(){
  if (!requireDealer()) return;
  if (!rakeHistory.length) return;
  rakeTotal -= rakeHistory.pop();
  updateDisplay();
}

async function nextHand(){
  if (!requireDealer()) return;
  if (isSubmitting) return;
  if (!selectedPlayerId) return alert("Select a seat");
  if (rakeTotal === 0){ openModal(); return; }
  await createHand();
}

function openModal(){ document.getElementById("noRakeModal").style.display = "flex"; }
function closeModal(){ document.getElementById("noRakeModal").style.display = "none"; }
async function confirmNoRake(){ if (!requireDealer()) return; closeModal(); await createHand(); }

async function createHand(){
  if (!requireDealer()) return;
  try{
    isSubmitting = true;
    updateDisplay();

    const { error } = await sb.from("rake_logs").insert({
      table_uid: TABLE_UID,
      dealer_uid: DEALER_UID,
      player_uid: selectedPlayerId,
      rake: rakeTotal
    });

    if (error) throw error;
    resetUI();
  }catch(err){
    console.error(err);
    alert(err.message || "Insert failed");
  }finally{
    isSubmitting = false;
    updateDisplay();
  }
}

function resetUI(){
  rakeTotal = 0;
  rakeHistory = [];
  selectedPlayerId = null;
  selectedSeatNumber = null;

  document.getElementById("selectedSeat").innerText = "No seat selected";
  updateDisplay();
  resetSlider();
  renderSeats();
}

/* ===== restore ===== */
(async function restoreSessions(){
  const savedUid = localStorage.getItem("table_uid");
  const savedName = localStorage.getItem("table_name");
  if (savedUid){
    TABLE_UID = savedUid;
    TABLE_NAME = savedName || savedUid;

    // refresh table_name from DB (để chắc đúng)
    try{
      const { data } = await sb.from('tables').select('table_name').eq('table_uid', TABLE_UID).single();
      const name = (data?.table_name || "").trim();
      if (name){
        TABLE_NAME = name;
        localStorage.setItem("table_name", TABLE_NAME);
      }
    }catch(e){}

    const duid = localStorage.getItem("dealer_uid");
    const dname = localStorage.getItem("dealer_name");
    if (duid){
      DEALER_UID = duid;
      DEALER_NAME = dname || duid;
    }

    setTableUI();
    setDealerUI();
    updateDisplay();
    await startTableSession();
  }else{
    setTableUI();
    setDealerUI();
    updateDisplay();
    setTimeout(openTableModal, 120);
  }
})();

console.log("table-counter themed (Rivebase center mark + pills)");
</script>

</body>
</html>
